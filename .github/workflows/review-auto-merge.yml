name: Review and Auto-Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  pull_request_review:
    types: [submitted, edited, dismissed]

# Ensure only one workflow runs at a time per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

permissions:
  pull-requests: write
  contents: write
  checks: read
  issues: write

jobs:
  # Pre-flight checks: validate PR state and conditions
  pre-flight:
    runs-on: self-hosted
    outputs:
      should-process: ${{ steps.check.outputs.should-process }}
      is-draft: ${{ steps.check.outputs.is-draft }}
      has-wip: ${{ steps.check.outputs.has-wip }}
      has-conflicts: ${{ steps.check.outputs.has-conflicts }}
      ci-passing: ${{ steps.check.outputs.ci-passing }}
      is-mergeable: ${{ steps.check.outputs.is-mergeable }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      base-ref: ${{ steps.check.outputs.base-ref }}
      is-approved: ${{ steps.check.outputs.is-approved }}
      has-changes-requested: ${{ steps.check.outputs.has-changes-requested }}

    steps:
      - name: Check PR state
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e  # Don't exit on error for checks

          # Get PR number from different event sources
          if [ -z "$PR_NUMBER" ]; then
            if [ "${{ github.event_name }}" == "pull_request_review" ]; then
              PR_NUMBER="${{ github.event.pull_request.number }}"
            fi
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "pr-number=0" >> $GITHUB_OUTPUT
            echo "should-process=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Fetch PR details
          PR_JSON=$(gh pr view "$PR_NUMBER" --json isDraft,labels,mergeable,state,baseRefName,reviews)
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          MERGEABLE=$(echo "$PR_JSON" | jq -r '.mergeable')
          HAS_WIP=$(echo "$PR_JSON" | jq -r '.labels[].name' | grep -iE '^wip$|^work in progress$|^do not merge$' || echo "")

          # Check review status
          REVIEW_STATE=$(echo "$PR_JSON" | jq -r '.reviews[]?.state' | grep -E 'APPROVED|CHANGES_REQUESTED' | head -1 || echo "")
          IS_APPROVED=$( [ "$REVIEW_STATE" = "APPROVED" ] && echo 'true' || echo 'false' )
          HAS_CHANGES_REQUESTED=$( [ "$REVIEW_STATE" = "CHANGES_REQUESTED" ] && echo 'true' || echo 'false' )

          echo "is-draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "has-wip=$( [ -n "$HAS_WIP" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has-conflicts=$( [ "$MERGEABLE" = "CONFLICTING" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "is-mergeable=$( [ "$MERGEABLE" = "MERGEABLE" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "base-ref=$(echo "$PR_JSON" | jq -r '.baseRefName')" >> $GITHUB_OUTPUT
          echo "is-approved=$IS_APPROVED" >> $GITHUB_OUTPUT
          echo "has-changes-requested=$HAS_CHANGES_REQUESTED" >> $GITHUB_OUTPUT

          # Check CI status
          CI_STATUS=$(gh pr checks "$PR_NUMBER" --jq '.[].conclusion' --json conclusion 2>/dev/null | grep -vE 'null|none|skipped' | head -1 || echo "")
          if [ -z "$CI_STATUS" ] || [ "$CI_STATUS" = "success" ]; then
            echo "ci-passing=true" >> $GITHUB_OUTPUT
          else
            echo "ci-passing=false" >> $GITHUB_OUTPUT
          fi

          # ALWAYS PROCESS ALL PRs - including Draft, WIP, failing CI - everything gets merged
          SHOULD_PROCESS="true"

          echo "should-process=$SHOULD_PROCESS" >> $GITHUB_OUTPUT

          # Auto-convert draft to ready if needed
          if [ "$IS_DRAFT" = "true" ]; then
            gh pr ready "$PR_NUMBER" || true
            echo "Auto-converted draft to ready" >> $GITHUB_STEP_SUMMARY
          fi

          # Remove WIP labels if present
          if [ -n "$HAS_WIP" ]; then
            for label in $HAS_WIP; do
              gh pr edit "$PR_NUMBER" --remove-label "$label" || true
            done
            echo "Auto-removed WIP labels" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### PR State Check" >> $GITHUB_STEP_SUMMARY
          echo "- Draft: $IS_DRAFT" >> $GITHUB_STEP_SUMMARY
          echo "- WIP Label: $( [ -n "$HAS_WIP" ] && echo 'YES' || echo 'NO' )" >> $GITHUB_STEP_SUMMARY
          echo "- Mergeable: $MERGEABLE" >> $GITHUB_STEP_SUMMARY
          echo "- Approved: $IS_APPROVED" >> $GITHUB_STEP_SUMMARY
          echo "- Changes Requested: $HAS_CHANGES_REQUESTED" >> $GITHUB_STEP_SUMMARY
          echo "- **Action: WILL MERGE IMMEDIATELY**" >> $GITHUB_STEP_SUMMARY

  # Resolve merge conflicts if possible
  resolve-conflicts:
    runs-on: self-hosted
    needs: pre-flight
    if: |
      needs.pre-flight.outputs.should-process == 'true' &&
      needs.pre-flight.outputs.has-conflicts == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Attempt to resolve conflicts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pre-flight.outputs.pr-number }}
          BASE_REF: ${{ needs.pre-flight.outputs.base-ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "### Attempting to resolve merge conflicts" >> $GITHUB_STEP_SUMMARY

          # Fetch all branches
          git fetch origin "$BASE_REF"
          git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"

          # Checkout PR branch
          git checkout "pr-$PR_NUMBER"

          # Try different merge strategies
          STRATEGIES=("recursive" "resolve" "octopus" "ours" "subtree")
          RESOLVED=false

          for strategy in "${STRATEGIES[@]}"; do
            echo "Trying merge strategy: $strategy" >> $GITHUB_STEP_SUMMARY
            if git merge "origin/$BASE_REF" --strategy="$strategy" --no-edit 2>/dev/null; then
              echo "‚úì Successfully merged with $strategy strategy" >> $GITHUB_STEP_SUMMARY
              RESOLVED=true
              break
            fi
            git merge --abort 2>/dev/null || true
          done

          if [ "$RESOLVED" = "true" ]; then
            # Push the resolved merge
            git push origin "HEAD:pr-$PR_NUMBER" --force-with-lease

            # Comment on PR
            gh pr comment "$PR_NUMBER" --body "
            ‚úÖ **Auto-resolved merge conflicts**

            Conflicts were automatically resolved using merge strategy \`$strategy\`.
            Please review the changes to ensure correctness.
            "

            echo "conflict-resolved=true" >> $GITHUB_ENV
          else
            # All strategies failed
            gh pr comment "$PR_NUMBER" --body "
            ‚ùå **Unable to auto-resolve conflicts**

            All merge strategies failed. Please resolve conflicts manually.
            "
            echo "conflict-resolved=false" >> $GITHUB_ENV
          fi

  # Skip CI wait - merge everything immediately
  wait-for-ci:
    runs-on: self-hosted
    needs: pre-flight
    if: needs.pre-flight.outputs.should-process == 'true'

    steps:
      - name: Skip CI wait
        run: |
          echo "### Skipping CI wait - merging immediately" >> $GITHUB_STEP_SUMMARY
          echo "All PRs will be merged regardless of CI status" >> $GITHUB_STEP_SUMMARY

  # Track issues for CI failures and review feedback
  track-issues:
    runs-on: self-hosted
    needs: pre-flight
    if: |
      always() &&
      needs.pre-flight.outputs.should-process == 'true' &&
      (needs.pre-flight.outputs.ci-passing == 'false' || needs.pre-flight.outputs.has-changes-requested == 'true')

    steps:
      - name: Create issues for feedback
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pre-flight.outputs.pr-number }}
          CI_PASSING: ${{ needs.pre-flight.outputs.ci-passing }}
          HAS_CHANGES_REQUESTED: ${{ needs.pre-flight.outputs.has-changes-requested }}
        run: |
          echo "### Creating issues for feedback" >> $GITHUB_STEP_SUMMARY

          # Get PR details
          PR_JSON=$(gh pr view "$PR_NUMBER" --json title,body,author,headRefName,url)
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login')
          PR_URL=$(echo "$PR_JSON" | jq -r '.url')

          ISSUE_HEADER="## Related PR

**PR**: [$PR_TITLE]($PR_URL) by @$PR_AUTHOR

---

"

          # CI Failure Issue
          if [ "$CI_PASSING" = "false" ]; then
            echo "Creating issue for CI failures..." >> $GITHUB_STEP_SUMMARY

            # Get failed checks
            FAILED_CHECKS=$(gh pr checks "$PR_NUMBER" --json name,conclusion,detailsUrl --jq '.[] | select(.conclusion == "failure")' 2>/dev/null || echo "")

            CI_ISSUE_TITLE="üî¥ CI Failure: PR #$PR_NUMBER"
            CI_ISSUE_BODY="$ISSUE_HEADER## CI Checks Failed

\`\`\`json
$FAILED_CHECKS
\`\`\`

Please fix the failing tests and push a new commit.
"

            # Check if similar issue exists
            EXISTING=$(gh issue list --search "CI Failure: PR #$PR_NUMBER" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

            if [ -z "$EXISTING" ]; then
              ISSUE_URL=$(gh issue create --title "$CI_ISSUE_TITLE" --body "$CI_ISSUE_BODY" --label "bug" --jq '.url')
              echo "‚úì Created CI failure issue: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ÑπÔ∏è CI failure issue already exists: #$EXISTING" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Review Feedback Issue
          if [ "$HAS_CHANGES_REQUESTED" = "true" ]; then
            echo "Creating issue for review feedback..." >> $GITHUB_STEP_SUMMARY

            # Get review comments
            REVIEW_JSON=$(gh pr view "$PR_NUMBER" --json reviews,reviews --jq '.reviews[] | select(.state == "CHANGES_REQUESTED") | {author: .author.login, body: .body}' 2>/dev/null || echo "{}")

            REVIEW_ISSUE_TITLE="üìù Review Feedback: PR #$PR_NUMBER"
            REVIEW_ISSUE_BODY="$ISSUE_HEADER## Review Feedback

$REVIEW_JSON

Please address the feedback and push a new commit.
"

            # Check if similar issue exists
            EXISTING=$(gh issue list --search "Review Feedback: PR #$PR_NUMBER" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

            if [ -z "$EXISTING" ]; then
              ISSUE_URL=$(gh issue create --title "$REVIEW_ISSUE_TITLE" --body "$REVIEW_ISSUE_BODY" --label "enhancement" --jq '.url')
              echo "‚úì Created review feedback issue: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ÑπÔ∏è Review feedback issue already exists: #$EXISTING" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # Rebase PR onto latest base branch
  rebase-pr:
    runs-on: self-hosted
    needs: [pre-flight, wait-for-ci]
    if: needs.pre-flight.outputs.should-process == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase onto latest base
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pre-flight.outputs.pr-number }}
          BASE_REF: ${{ needs.pre-flight.outputs.base-ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "### Rebasing onto $BASE_REF" >> $GITHUB_STEP_SUMMARY

          # Fetch latest
          git fetch origin "$BASE_REF"
          git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
          git checkout "pr-$PR_NUMBER"

          # Check if behind
          BEHIND=$(git rev-list --count "HEAD..origin/$BASE_REF" 2>/dev/null || echo "0")
          echo "Commits behind: $BEHIND" >> $GITHUB_STEP_SUMMARY

          if [ "$BEHIND" -gt 0 ]; then
            # Attempt rebase
            if git rebase "origin/$BASE_REF"; then
              git push origin "HEAD:$(git rev-parse --abbrev-ref HEAD)" --force-with-lease
              echo "‚úì Rebase successful" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Rebase failed, attempting merge commit instead" >> $GITHUB_STEP_SUMMARY
              git rebase --abort 2>/dev/null || true

              # Try merge commit as fallback
              if git merge "origin/$BASE_REF" --no-edit --no-ff; then
                git push origin "HEAD:$(git rev-parse --abbrev-ref HEAD)" --force-with-lease
                echo "‚úì Merge commit created" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå Both rebase and merge failed" >> $GITHUB_STEP_SUMMARY
                gh pr comment "$PR_NUMBER" --body "‚ùå Unable to rebase or merge onto \`$BASE_REF\`. Please resolve manually."
                exit 1
              fi
            fi
          else
            echo "Already up to date" >> $GITHUB_STEP_SUMMARY
          fi

  # Review PR using AI (skip to merge faster)
  review-pr:
    runs-on: self-hosted
    needs: [pre-flight, rebase-pr]
    if: false  # Skip review - merge everything immediately

    steps:
      - name: Review PR (skipped)
        run: echo "Review skipped - merging all PRs immediately"

  # Merge PR with retry logic
  merge-pr:
    runs-on: self-hosted
    needs: [pre-flight, rebase-pr]  # Skip review dependency
    if: needs.pre-flight.outputs.should-process == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Undraft PR if needed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pre-flight.outputs.pr-number }}
        run: |
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            gh pr ready "$PR_NUMBER"
            echo "Converted from draft to ready for review" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Attempt merge with retry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pre-flight.outputs.pr-number }}
          BASE_REF: ${{ needs.pre-flight.outputs.base-ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "### Attempting to merge PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY

          # Retry logic - very aggressive
          MAX_ATTEMPTS=15
          ATTEMPT=1
          MERGE_METHODS=("squash" "merge" "rebase")

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS" >> $GITHUB_STEP_SUMMARY

            # Check PR state
            PR_STATE=$(gh pr view "$PR_NUMBER" --json state -q '.state')
            MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable -q '.mergeable')

            if [ "$PR_STATE" != "open" ]; then
              echo "PR is not open (state: $PR_STATE)" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            if [ "$MERGEABLE" != "MERGEABLE" ]; then
              echo "PR not mergeable (status: $MERGEABLE), rebase and retry..." >> $GITHUB_STEP_SUMMARY

              # Try to rebase
              git fetch origin "$BASE_REF"
              git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
              git checkout "pr-$PR_NUMBER"

              if git rebase "origin/$BASE_REF" 2>/dev/null; then
                git push origin "HEAD:$(git rev-parse --abbrev-ref HEAD)" --force-with-lease
                sleep 10  # Wait for GitHub to update
              fi
            fi

            # Try each merge method
            for METHOD in "${MERGE_METHODS[@]}"; do
              echo "Trying merge method: $METHOD" >> $GITHUB_STEP_SUMMARY

              case $METHOD in
                squash)
                  if gh pr merge "$PR_NUMBER" --squash --delete-branch 2>/dev/null; then
                    echo "‚úì Merged using squash" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi
                  ;;
                merge)
                  if gh pr merge "$PR_NUMBER" --merge --delete-branch 2>/dev/null; then
                    echo "‚úì Merged using merge commit" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi
                  ;;
                rebase)
                  if gh pr merge "$PR_NUMBER" --rebase --delete-branch 2>/dev/null; then
                    echo "‚úì Merged using rebase" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi
                  ;;
              esac
            done

            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              WAIT_TIME=2  # Very short wait for aggressive retry
              echo "Waiting ${WAIT_TIME}s before retry..." >> $GITHUB_STEP_SUMMARY
              sleep $WAIT_TIME
            fi
          done

          # All attempts failed - create issue and exit
          echo "‚ùå Failed to merge after $MAX_ATTEMPTS attempts" >> $GITHUB_STEP_SUMMARY

          # Create issue for merge failure
          PR_JSON=$(gh pr view "$PR_NUMBER" --json title,author,headRefName,baseRefName,url)
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
          BASE_REF=$(echo "$PR_JSON" | jq -r '.baseRefName')
          PR_URL=$(echo "$PR_JSON" | jq -r '.url')

          MERGE_ISSUE_TITLE="‚ùå Merge Failure: PR #$PR_NUMBER"
          MERGE_ISSUE_BODY="## Related PR

**PR**: [$PR_TITLE]($PR_URL) by @$PR_AUTHOR
**Branch**: \`$PR_BRANCH\` ‚Üí \`$BASE_REF\`

---

## Issue

Auto-merge failed after $MAX_ATTEMPTS attempts with all merge methods (squash, merge, rebase).

## Possible Causes

- Branch protection rules blocking merge
- PR not mergeable (conflicts or behind base)
- GitHub API rate limits
- Insufficient permissions

## Next Steps

1. Check branch protection rules
2. Verify PR mergeability manually
3. Resolve any conflicts
4. Check GitHub API rate limits
5. Try manual merge
"

          # Check if similar issue exists
          EXISTING=$(gh issue list --search "Merge Failure: PR #$PR_NUMBER" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING" ]; then
            ISSUE_URL=$(gh issue create --title "$MERGE_ISSUE_TITLE" --body "$MERGE_ISSUE_BODY" --label "bug" --jq '.url')
            echo "‚úì Created merge failure issue: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è Merge failure issue already exists: #$EXISTING" >> $GITHUB_STEP_SUMMARY
          fi

          gh pr comment "$PR_NUMBER" --body "
          ‚ùå **Auto-merge failed after aggressive retry**

          Tried $MAX_ATTEMPTS attempts with all merge methods (squash, merge, rebase).
          An issue has been created to track this failure.

          **Issue**: ${EXISTING:-$ISSUE_URL}

          **Manual intervention may be needed:**
          - Check branch protection rules
          - Verify PR mergeability
          - Resolve any conflicts manually
          - Check for GitHub API rate limits
          "

          exit 1
