name: 'Test All Actions (Dry Run)'

description: 'Run dry-run validation tests for all AI Actions in this repository'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Specific action to test (empty = test all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'review-and-merge'
          - 'spec-to-code'
          - 'action-fixer'
          - 'auto-refactor'
          - 'auto-document'
          - 'release-notes-ai'
  pull_request:
    paths:
      - 'actions/**/action.yml'
      - 'actions/**/templates/**'
      - '.github/workflows/test-all-actions.yml'
  push:
    branches:
      - main
    paths:
      - 'actions/**/action.yml'
      - 'actions/**/templates/**'
      - '.github/workflows/test-all-actions.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  setup:
    name: 'Setup Test Environment'
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set matrix
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.action }}" ]; then
            # Test specific action
            echo 'matrix=["${{ github.event.inputs.action }}"]' >> $GITHUB_OUTPUT
          else
            # Test all actions
            echo 'matrix=["review-and-merge","spec-to-code","action-fixer","auto-refactor","auto-document","release-notes-ai"]' >> $GITHUB_OUTPUT
          fi

      - name: Check Claude CLI availability
        id: check
        run: |
          # Check if claude command is available on self-hosted runner
          if command -v claude &> /dev/null; then
            echo "Claude CLI found: $(claude --version 2>&1 || echo 'version unknown')"
            echo 'should-run=true' >> $GITHUB_OUTPUT
          else
            echo "::warning::Claude CLI not found. Please install on self-hosted runner."
            echo 'should-run=false' >> $GITHUB_OUTPUT
          fi

  # Test review-and-merge
  test-review-and-merge:
    name: 'Test review-and-merge'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run review-and-merge (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running review-and-merge in dry-run mode"
          echo "Action path: ${{ github.action_path }}"
          echo "Testing review functionality..."

          # Check action.yml exists
          if [ ! -f "actions/review-and-merge/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/review-and-merge/templates/fix_prompt.txt" ]; then
            echo "::error::fix_prompt.txt not found"
            exit 1
          fi

          if [ ! -f "actions/review-and-merge/templates/review_prompt.txt" ]; then
            echo "::error::review_prompt.txt not found"
            exit 1
          fi

          if [ ! -f "actions/review-and-merge/templates/comment_template.txt" ]; then
            echo "::error::comment_template.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/review-and-merge/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… review-and-merge: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Test spec-to-code
  test-spec-to-code:
    name: 'Test spec-to-code'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run spec-to-code (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running spec-to-code in dry-run mode"

          # Check action.yml exists
          if [ ! -f "actions/spec-to-code/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/spec-to-code/templates/gen_prompt.txt" ]; then
            echo "::error::gen_prompt.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/spec-to-code/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… spec-to-code: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Test action-fixer
  test-action-fixer:
    name: 'Test action-fixer'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run action-fixer (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running action-fixer in dry-run mode"

          # Check action.yml exists
          if [ ! -f "actions/action-fixer/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/action-fixer/templates/fix_prompt.txt" ]; then
            echo "::error::fix_prompt.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/action-fixer/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… action-fixer: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Test auto-refactor
  test-auto-refactor:
    name: 'Test auto-refactor'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run auto-refactor (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running auto-refactor in dry-run mode"

          # Check action.yml exists
          if [ ! -f "actions/auto-refactor/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/auto-refactor/templates/refactor_prompt.txt" ]; then
            echo "::error::refactor_prompt.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/auto-refactor/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… auto-refactor: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Test auto-document
  test-auto-document:
    name: 'Test auto-document'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run auto-document (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running auto-document in dry-run mode"

          # Check action.yml exists
          if [ ! -f "actions/auto-document/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/auto-document/templates/doc_prompt.txt" ]; then
            echo "::error::doc_prompt.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/auto-document/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… auto-document: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Test release-notes-ai
  test-release-notes-ai:
    name: 'Test release-notes-ai'
    needs: setup
    if: needs.setup.outputs.should-run == 'true'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run release-notes-ai (dry-run)
        id: test-action
        env:
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: true
        run: |
          echo "::group::Running release-notes-ai in dry-run mode"

          # Check action.yml exists
          if [ ! -f "actions/release-notes-ai/action.yml" ]; then
            echo "::error::action.yml not found"
            exit 1
          fi

          # Check templates exist
          if [ ! -f "actions/release-notes-ai/templates/release_prompt.txt" ]; then
            echo "::error::release_prompt.txt not found"
            exit 1
          fi

          echo "::endgroup::"

          # Validate YAML syntax
          echo "::group::Validate YAML syntax"
          python3 -c "import yaml; yaml.safe_load(open('actions/release-notes-ai/action.yml'))"
          echo "::endgroup::"

          echo "::notice::âœ… release-notes-ai: Action structure validated successfully"

      - name: Check outputs
        run: |
          echo "Verifying expected outputs..."
          echo "âœ“ Action executed without errors"
          echo "âœ“ All template files exist"
          echo "âœ“ YAML syntax is valid"

  # Summary report
  summary:
    name: 'Test Summary'
    needs: [setup, test-review-and-merge, test-spec-to-code, test-action-fixer, test-auto-refactor, test-auto-document, test-release-notes-ai]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| review-and-merge | ${{ needs.test-review-and-merge.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spec-to-code | ${{ needs.test-spec-to-code.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| action-fixer | ${{ needs.test-action-fixer.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| auto-refactor | ${{ needs.test-auto-refactor.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| auto-document | ${{ needs.test-auto-document.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| release-notes-ai | ${{ needs.test-release-notes-ai.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Mode" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: Enabled (no actual changes made)" >> $GITHUB_STEP_SUMMARY
          echo "- **Claude CLI**: Uses pre-configured command on self-hosted runner" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit/Push**: Skipped" >> $GITHUB_STEP_SUMMARY
