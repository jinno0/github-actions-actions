name: Check Data Collection

on:
  schedule:
    # 毎週月曜9時JST (0時UTC) に実行
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (generates test data)'
        required: false
        type: boolean
        default: false

jobs:
  check-data:
    name: Check Review Metrics Collection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyyaml

      - name: Generate test data (if test mode)
        if: inputs.test_mode == true
        run: |
          python scripts/test_data_collection.py
          echo "✅ Test data generated"

      - name: Check review metrics file exists
        id: check_file
        run: |
          if [ ! -f metrics/review_metrics.json ]; then
            echo "⚠️ review_metrics.json not found"
            echo "status=not_found" >> $GITHUB_OUTPUT
            echo "Data collection has not started yet"
            exit 0  # 失敗させない（パイロット段階）
          fi
          echo "status=found" >> $GITHUB_OUTPUT
          echo "✅ review_metrics.json found"

      - name: Calculate acceptance rate
        if: steps.check_file.outputs.status == 'found'
        run: |
          python scripts/calculate_acceptance_rate.py \
            --time-period 30d \
            --output report \
            --baseline || echo "⚠️ Could not calculate acceptance rate"

      - name: Generate summary
        if: always()
        run: |
          echo "## Data Collection Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.check_file.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Check Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- If status is 'not_found': Start pilot projects to collect data" >> $GITHUB_STEP_SUMMARY
          echo "- If status is 'found': Review acceptance rate report" >> $GITHUB_STEP_SUMMARY

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.check_file.outputs.status }}" = "found" ]; then
            echo "✅ Data collection is active"
            echo "Review the acceptance rate in the logs above"
          else
            echo "⚠️ Data collection not yet started"
            echo "This is expected during pilot phase"
          fi
