name: External Dispatch Handler

# This workflow allows external control from a private repository
# Secrets and automation logic can be kept private while this repo stays public

on:
  repository_dispatch:
    types:
      - ai-review           # Trigger AI review for a PR
      - bulk-merge          # Bulk merge multiple PRs
      - auto-rebase         # Rebase a PR
      - run-tests           # Run tests on demand
      - enable-auto-merge   # Enable GitHub's auto-merge for a PR
      - direct-merge        # Directly merge a PR (no auto-merge)
      - review-and-merge    # Combined: review + auto-merge enable

permissions:
  pull-requests: write
  contents: write
  checks: read

jobs:
  # ============================================
  # AI Review triggered externally
  # ============================================
  ai-review:
    if: github.event.action == 'ai-review'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}
          fetch-depth: 0

      - name: AI Review and Fix
        id: review
        uses: ./actions/review-and-merge
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          claude-model: ${{ github.event.client_payload.model || 'sonnet' }}
          auto-fix: ${{ github.event.client_payload.auto_fix || 'true' }}
          lgtm-threshold: ${{ github.event.client_payload.lgtm_threshold || '7' }}
          pr-number: ${{ github.event.client_payload.pr_number }}

      - name: Report result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          VERDICT: ${{ steps.review.outputs.verdict }}
          CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
        run: |
          echo "### AI Review Result" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- Verdict: $VERDICT" >> $GITHUB_STEP_SUMMARY

          # Optional: callback to controller repo
          if [ -n "$CALLBACK_URL" ]; then
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"pr\": $PR_NUMBER, \"verdict\": \"$VERDICT\"}" || true
          fi

  # ============================================
  # Bulk merge triggered externally
  # ============================================
  bulk-merge:
    if: github.event.action == 'bulk-merge'
    runs-on: ubuntu-latest
    steps:
      - name: Bulk Merge PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIMIT: ${{ github.event.client_payload.limit || '10' }}
          MERGE_METHOD: ${{ github.event.client_payload.merge_method || 'squash' }}
          LABEL_FILTER: ${{ github.event.client_payload.label_filter || '' }}
        run: |
          echo "### Bulk Merge Operation" >> $GITHUB_STEP_SUMMARY
          echo "- Limit: $LIMIT" >> $GITHUB_STEP_SUMMARY
          echo "- Method: $MERGE_METHOD" >> $GITHUB_STEP_SUMMARY

          # Get mergeable PRs
          QUERY=".[] | select(.mergeable == \"MERGEABLE\" and .mergeStateStatus == \"CLEAN\")"
          if [ -n "$LABEL_FILTER" ]; then
            QUERY="$QUERY | select(.labels[].name == \"$LABEL_FILTER\")"
          fi

          PRS=$(gh pr list --state open --json number,mergeable,mergeStateStatus,labels,isDraft \
            --jq "$QUERY | .number" | head -n "$LIMIT")

          MERGED=0
          FAILED=0

          for pr in $PRS; do
            # Make draft PRs ready first
            IS_DRAFT=$(gh pr view "$pr" --json isDraft -q '.isDraft')
            if [ "$IS_DRAFT" = "true" ]; then
              gh pr ready "$pr" || continue
              sleep 2
            fi

            # Attempt merge
            if gh pr merge "$pr" --"$MERGE_METHOD" --delete-branch 2>/dev/null; then
              echo "âœ… Merged PR #$pr" >> $GITHUB_STEP_SUMMARY
              MERGED=$((MERGED + 1))
            else
              echo "âŒ Failed to merge PR #$pr" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
            fi
            sleep 1
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary**: Merged $MERGED, Failed $FAILED" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Auto-rebase triggered externally
  # ============================================
  auto-rebase:
    if: github.event.action == 'auto-rebase'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          USE_AI: ${{ github.event.client_payload.use_ai || 'false' }}
        run: |
          echo "### Auto-Rebase PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY

          # Get PR branch info
          PR_INFO=$(gh pr view "$PR_NUMBER" --json headRefName,baseRefName)
          HEAD_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
          BASE_BRANCH=$(echo "$PR_INFO" | jq -r '.baseRefName')

          git fetch origin "$BASE_BRANCH" "$HEAD_BRANCH"
          git checkout "$HEAD_BRANCH"

          if git rebase "origin/$BASE_BRANCH"; then
            git push --force-with-lease
            echo "âœ… Rebase successful" >> $GITHUB_STEP_SUMMARY
          else
            if [ "$USE_AI" = "true" ]; then
              echo "âš ï¸ Conflicts detected, attempting AI resolution..." >> $GITHUB_STEP_SUMMARY
              # Claude Code would handle conflict resolution here
              git rebase --abort
              echo "âŒ AI conflict resolution not implemented in this action" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              git rebase --abort
              echo "âŒ Rebase failed - conflicts detected" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  # ============================================
  # Run tests on demand
  # ============================================
  run-tests:
    if: github.event.action == 'run-tests'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Tests
        run: |
          echo "### Test Run" >> $GITHUB_STEP_SUMMARY

          # Find and validate all action.yml files
          for action_dir in actions/*/; do
            action_name=$(basename "$action_dir")
            echo "Testing: $action_name" >> $GITHUB_STEP_SUMMARY

            if [ -f "$action_dir/action.yml" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$action_dir/action.yml'))" \
                && echo "  âœ… YAML valid" >> $GITHUB_STEP_SUMMARY \
                || echo "  âŒ YAML invalid" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ============================================
  # Enable GitHub's auto-merge for a PR
  # (Replaces review-and-auto-merge.yml functionality)
  # ============================================
  enable-auto-merge:
    if: github.event.action == 'enable-auto-merge'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Auto-Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          MERGE_METHOD: ${{ github.event.client_payload.merge_method || 'squash' }}
        run: |
          echo "### Enabling Auto-Merge for PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check PR status
          STATE=$(gh pr view "$PR_NUMBER" --json state -q '.state')
          if [ "$STATE" != "OPEN" ]; then
            echo "PR is not open (state: $STATE)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            # Optionally make it ready
            if [ "${{ github.event.client_payload.ready_draft }}" = "true" ]; then
              gh pr ready "$PR_NUMBER"
              echo "ðŸ“ Marked draft PR as ready" >> $GITHUB_STEP_SUMMARY
            else
              echo "PR is a draft, skipping auto-merge" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          fi

          # Enable GitHub's built-in auto-merge
          if gh pr merge "$PR_NUMBER" --auto --"$MERGE_METHOD" --delete-branch 2>&1; then
            echo "âœ… Auto-merge enabled!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PR will automatically merge when CI checks pass." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Could not enable auto-merge (may already be enabled or not allowed)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Directly merge a PR (no auto-merge)
  # For repos without auto-merge feature or for immediate merge
  # ============================================
  direct-merge:
    if: github.event.action == 'direct-merge'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Direct Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          MERGE_METHOD: ${{ github.event.client_payload.merge_method || 'squash' }}
          READY_DRAFT: ${{ github.event.client_payload.ready_draft || 'false' }}
        run: |
          set -x  # Enable debug output
          echo "### Direct Merge PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "Starting direct-merge for PR #$PR_NUMBER"

          # Check PR status
          echo "Checking PR state..."
          STATE=$(gh pr view "$PR_NUMBER" --json state -q '.state')
          echo "PR state: $STATE"
          if [ "$STATE" != "OPEN" ]; then
            echo "â­ï¸ PR is not open (state: $STATE)" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "Checking draft status..."
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q '.isDraft')
          echo "Is draft: $IS_DRAFT"
          if [ "$IS_DRAFT" = "true" ]; then
            if [ "$READY_DRAFT" = "true" ]; then
              gh pr ready "$PR_NUMBER"
              echo "ðŸ“ Marked draft PR as ready" >> $GITHUB_STEP_SUMMARY
            else
              echo "â­ï¸ PR is a draft, skipping" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          fi

          # Check if PR is mergeable
          echo "Checking mergeable status..."
          MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable -q '.mergeable')
          echo "Mergeable: $MERGEABLE"
          if [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "âš ï¸ PR is not mergeable (status: $MERGEABLE)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Direct merge
          echo "Attempting merge..."
          if gh pr merge "$PR_NUMBER" --"$MERGE_METHOD" --delete-branch; then
            echo "âœ… PR merged successfully!" >> $GITHUB_STEP_SUMMARY
            echo "Merge completed successfully"
          else
            echo "âŒ Failed to merge PR" >> $GITHUB_STEP_SUMMARY
            echo "Merge failed"
            exit 1
          fi

  # ============================================
  # Combined: AI Review + Auto-merge enable
  # (Full replacement for review-and-auto-merge.yml)
  # ============================================
  review-and-merge:
    if: github.event.action == 'review-and-merge'
    runs-on: self-hosted
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}
          fetch-depth: 0

      - name: AI Review
        id: review
        uses: ./actions/review-and-merge
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          claude-model: ${{ github.event.client_payload.model || 'sonnet' }}
          auto-fix: ${{ github.event.client_payload.auto_fix || 'true' }}
          lgtm-threshold: ${{ github.event.client_payload.lgtm_threshold || '7' }}
          pr-number: ${{ github.event.client_payload.pr_number }}

      - name: Enable Auto-Merge if LGTM
        if: steps.review.outputs.verdict == 'LGTM'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          MERGE_METHOD: ${{ github.event.client_payload.merge_method || 'squash' }}
        run: |
          echo "### Enabling Auto-Merge (Verdict: LGTM)" >> $GITHUB_STEP_SUMMARY

          # Check if PR is still open
          STATE=$(gh pr view "$PR_NUMBER" --json state -q '.state')
          if [ "$STATE" != "OPEN" ]; then
            echo "PR is no longer open" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Enable auto-merge
          if gh pr merge "$PR_NUMBER" --auto --"$MERGE_METHOD" --delete-branch 2>&1; then
            echo "âœ… Auto-merge enabled!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Could not enable auto-merge" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Report Result
        if: always()
        env:
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          VERDICT: ${{ steps.review.outputs.verdict }}
          CONFIDENCE: ${{ steps.review.outputs.confidence }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- Verdict: $VERDICT" >> $GITHUB_STEP_SUMMARY
          echo "- Confidence: $CONFIDENCE" >> $GITHUB_STEP_SUMMARY
