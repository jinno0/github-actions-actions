version: "2.0"
generated_at: "2026-02-07T00:00:00Z"
generated_by: "audit-run-001"

# === Core Function Verification Scenarios ===

scenarios:
  # === CF-001: 13種類のAI Actionsを提供している ===
  - function_id: "CF-001"
    name: "Actionsが正しくカウントされる"
    description: "actions/ディレクトリ以下に13個の有効なActionが存在することを検証"

    input:
      type: "directory_scan"
      path: "actions/"
      pattern: "*/action.yml"
      validation: "YAML構文が正しいこと"

    expected_output:
      type: "count"
      value: 13
      allowed_actions:
        - "action-fixer"
        - "auto-document"
        - "auto-merge"
        - "auto-rebase"
        - "auto-refactor"
        - "bulk-merge-prs"
        - "bulk-rebase-prs"
        - "pr-review-enqueuer"
        - "publish-pr"
        - "release-notes-ai"
        - "review-and-merge"
        - "review-auto-merge"
        - "spec-to-code"

    validation_rules:
      - "全てのaction.ymlがYAMLとしてパース可能"
      - "name, description, runsフィールドが存在"
      - "actions/_shared/とactions/lib/は除外"

    edge_cases:
      - name: "シンボリックリンク"
        expected: "実体ファイルのみカウント"

  # === CF-002: 全ActionにExampleとInstructionが存在 ===
  - function_id: "CF-002"
    name: "Example-Instruction対応表の整合性"
    description: "全Actionに対して、Example WorkflowとInstruction Guideが1:1で存在することを検証"

    input:
      type: "file_comparison"
      sources:
        - "examples/*.yml"
        - "instructions/*.md"
      reference: "actions/ディレクトリ"

    expected_output:
      type: "mapping"
      coverage: "100%"
      rules:
        - "各Action {action-name} に対して examples/{action-name}-example.yml が存在"
        - "各Action {action-name} に対して instructions/{action-name}.md が存在"
        - "例外: review-and-merge-custom-rules.md はカスタムルール用なので別扱い"

    validation_rules:
      - "ファイル数の不一致を特定"
      - "命名規則の一貫性をチェック"
      - "不足しているドキュメントをリストアップ"

    edge_cases:
      - name: "複数Exampleを持つAction"
        expected: "少なくとも1つのExampleが存在すればOK"

  # === CF-003: Claude Code CLIを活用した文脈理解レビュー ===
  - function_id: "CF-003"
    name: "review-and-merge ActionのClaude Code CLI統合"
    description: "review-and-merge ActionがClaude Code CLIを正しく呼び出していることを検証"

    input:
      type: "file_inspection"
      files:
        - "actions/review-and-merge/action.yml"
        - "actions/review-and-merge/templates/review_prompt.txt"
        - "actions/review-and-merge/scripts/review-and-fix.sh"

    expected_output:
      type: "code_analysis"
      requirements:
        - "action.yml で claude-model パラメータが定義されている"
        - "review_prompt.txt が Claude Code プロンプト形式である"
        - "実行スクリプトが 'claude' コマンドを呼び出している"
        - "context awareness（関連ファイルの参照）が実装されている"

    validation_rules:
      - "Claude Code CLI の必須オプションが指定されている"
      - "エラーハンドリングが存在する"
      - "出力形式が定義されている"

    edge_cases:
      - name: "CLI未インストール環境"
        expected: "適切なエラーメッセージが表示される"

  # === CF-004: カスタムレビュールール注入 ===
  - function_id: "CF-004"
    name: "カスタムルールの動作検証"
    description: "examples/custom-rules/ 以下のルールファイルが正しく動作することを検証"

    input:
      type: "test_files"
      samples:
        - "examples/custom-rules/python-style.yml"
        - "examples/custom-rules/typescript-strict.yml"
        - "examples/custom-rules/security-best-practices.yml"

    expected_output:
      type: "validation"
      requirements:
        - "YAMLとしてパース可能"
        - "rules: フィールドが存在"
        - "各ルールに id, category, pattern, explanation が含まれる"
        - "review-and-merge Action に custom-rules-path パラメータで渡せる"

    validation_rules:
      - "ルールの構造が一貫している"
      - "パターンが正規表現として有効"
      - "説明が明確で理解可能"

    edge_cases:
      - name: "空のルールファイル"
        expected: "エラーまたはデフォルトルール使用"
      - name: "不正な正規表現"
        expected: "バリデーションエラー"

  # === CF-005: Dry Runモードによる自動検証 ===
  - function_id: "CF-005"
    name: "Dry Run検証ワークフローの実行"
    description: ".github/workflows/test-with-dry-run.yml が実行可能で、全Actionを検証できること"

    input:
      type: "workflow_execution"
      workflow: ".github/workflows/test-with-dry-run.yml"
      mode: "dry_run"

    expected_output:
      type: "test_result"
      requirements:
        - "全Actionの構造チェックがパス"
        - "YAML構文検証がパス"
        - "モック実行が成功"
        - "エラーレポートが出力される"

    validation_rules:
      - "Exit code 0で終了"
      - "各Actionの検証結果がログに出力"
      - "失敗時は詳細なエラーメッセージ"

    edge_cases:
      - name: "構造的に無効なAction"
        expected: "検証失敗として検出される"

  # === CF-006: プライバシーを考慮したテレメトリー収集 ===
  - function_id: "CF-006"
    name: "テレメトリーのプライバシー機能検証"
    description: "テレメトリー収集スクリプトがオプトアウトと匿名化を実装していることを検証"

    input:
      type: "code_inspection"
      files:
        - "scripts/collect_metrics.py"
        - "scripts/aggregate_metrics.py"

    expected_output:
      type: "security_analysis"
      requirements:
        - "DISABLE_TELEMETRY 環境変数をチェックするコードが存在"
        - "SHA-256ハッシュ関数（hashlib）が使用されている"
        - "リポジトリ名がハッシュ化されている"
        - "PII/シークレットを除外するフィルタリングが存在"

    validation_rules:
      - "オプトアウト時は何も収集しない"
      - "ハッシュ化の前後でログに出力しない"
      - "収集データの最小限化（必須メトリクスのみ）"

    edge_cases:
      - name: "DISABLE_TELEMETRY='true' の場合"
        expected: "関数が早期リターンし、何も送信しない"
      - name: "ハッシュ化失敗"
        expected: "適切なエラーハンドリング"

  # === CF-007: AIレビュー品質メトリクス（受入率）の追跡 ===
  - function_id: "CF-007"
    name: "受入率計算スクリプトの実行"
    description: "scripts/calculate_acceptance_rate.py が実行可能で、受入率を正しく計算すること"

    input:
      type: "script_execution"
      script: "scripts/calculate_acceptance_rate.py"
      args: ["--output", "report", "--time-period", "30d"]
      mock_data:
        - "actions/lib/acceptance_tracker.py のスタブデータ"

    expected_output:
      type: "metrics_report"
      requirements:
        - "実行エラーなく終了"
        - "受入率（acceptance_rate）がパーセントで出力される"
        - "レビューアウトカム（approved/modified/rejected/needs_work）の集計"
        - "一般的な拒否理由のリストアップ"
        - "JSONまたはMarkdown形式のレポート生成"

    validation_rules:
      - "計算式: approved / (approved + modified + rejected + needs_work) * 100"
      - "データが存在しない場合は適切なメッセージ"
      - "期間フィルタが正しく動作"

    edge_cases:
      - name: "データがゼロ件"
        expected: "「データがありません」というメッセージ"
      - name: "不正な期間指定"
        expected: "バリデーションエラー"

  # === QA-001: テストカバレッジ計測 ===
  - function_id: "QA-001"
    name: "pytestによるカバレッジ計測"
    description: "pytest --cov を実行し、カバレッジ率を計測する"

    input:
      type: "test_execution"
      command: "pytest --cov=actions --cov=scripts --cov=tests --cov-report=term-missing --cov-report=json"

    expected_output:
      type: "coverage_report"
      requirements:
        - "全テストがパス"
        - "カバレッジ率がパーセントで表示"
        - "カバレッジレポートが coverage.json に生成"
        - "未カバー行がリストアップされる"

    validation_rules:
      - "Exit code 0"
      - "TOTAL カバレッジが計算されている"
      - "JSON レポートがパース可能"

    edge_cases:
      - name: "カバレッジ70%未満"
        expected: "テスト自体は成功するが、レポートで警告表示"

  # === QA-002: ドキュメントカバレッジ ===
  - function_id: "QA-002"
    name: "全Actionのドキュメント存在チェック"
    description: "各ActionにREADMEとInstructionが存在するか構造的にチェック"

    input:
      type: "structural_validation"
      script: |
        for action in actions/*/; do
          name=$(basename "$action")
          if [ ! -f "$action/README.md" ]; then
            echo "MISSING: $action/README.md"
          fi
          if [ ! -f "instructions/$name.md" ]; then
            echo "MISSING: instructions/$name.md"
          fi
        done

    expected_output:
      type: "validation_result"
      requirements:
        - "13個のAction全てに README.md が存在"
        - "13個のAction全てに instructions/*.md が存在"
        - "不足ファイルが0件"

    validation_rules:
      - "Exit code 0"
      - "MISSING メッセージが0件"

    edge_cases:
      - name: "大文字小文字の不一致"
        expected: "チェックで検出される"

  # === QA-003: YAML構文妥当性 ===
  - function_id: "QA-003"
    name: "全action.ymlのYAML検証"
    description: "全ActionのYAMLファイルがパース可能であることを検証"

    input:
      type: "syntax_validation"
      command: |
        for action in actions/*/action.yml; do
          yamllint "$action" || exit 1
        done

    expected_output:
      type: "validation_result"
      requirements:
        - "全action.ymlがパース可能"
        - "YAML構文エラーが0件"

    validation_rules:
      - "Exit code 0"
      - "yamllint エラーが0件"

    edge_cases:
      - name: "タブ文字使用"
        expected: "yamllint がエラーを検出"
      - name: "インデント不一致"
        expected: "yamllint がエラーを検出"

# === Test Data Requirements ===
test_data:
  directories_to_create:
    - path: ".audit/test_data/actions/"
      description: "Action検証用ダミーデータ"
    - path: ".audit/test_data/custom_rules/"
      description: "カスタムルール検証用ファイル"
    - path: ".audit/test_data/metrics/"
      description: "メトリクス計算用モックデータ"

  mock_files:
    - path: ".audit/test_data/metrics/sample_acceptance_data.json"
      content: |
        {
          "reviews": [
            {"outcome": "approved", "timestamp": "2026-01-01T00:00:00Z"},
            {"outcome": "modified", "timestamp": "2026-01-02T00:00:00Z"},
            {"outcome": "approved", "timestamp": "2026-01-03T00:00:00Z"}
          ]
        }
      purpose: "受入率計算スクリプトのテスト"

    - path: ".audit/test_data/custom_rules/test_rule.yml"
      content: |
        rules:
          - id: "TEST-001"
            category: "Style"
            pattern: "print\\("
            explanation: "Use logging instead of print"
      purpose: "カスタムルールパーサーのテスト"
