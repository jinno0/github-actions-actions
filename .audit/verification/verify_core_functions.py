#!/usr/bin/env python3
"""
Core Function Verification Script
Generated by Repo Genesis Auditor

検証対象:
1. CF-001: 13種類のAI Actionsを提供している
2. CF-002: Claude Code CLIを活用した高度な自動化
3. CF-004: Dry Run検証の実装状況
"""

import json
import sys
from dataclasses import asdict, dataclass
from pathlib import Path


@dataclass
class VerificationResult:
    function_id: str
    function_name: str
    passed: bool
    details: str
    evidence: list[str]
    interpretation: str

def verify_cf001_actions_count() -> VerificationResult:
    """CF-001: 13種類のAI Actionsを提供している"""
    actions_dir = Path("actions")
    action_yml_files = list(actions_dir.glob("*/action.yml"))
    count = len(action_yml_files)

    passed = count == 13
    action_names = [f.parent.name for f in action_yml_files]

    return VerificationResult(
        function_id="CF-001",
        function_name="13種類のAI Actionsを提供している",
        passed=passed,
        details=f"検出されたAction数: {count}/13",
        evidence=action_names,
        interpretation="13個のActionが存在し、README.mdの記載と一致している" if passed else f"Action数が期待値(13)と異なる: {count}"
    )

def verify_cf002_claude_cli_integration() -> VerificationResult:
    """CF-002: Claude Code CLIを活用した高度な自動化"""
    actions_dir = Path("actions")
    actions_with_claude = []
    actions_without_claude = []

    for action_dir in actions_dir.iterdir():
        if not action_dir.is_dir():
            continue

        action_yml = action_dir / "action.yml"
        if not action_yml.exists():
            continue

        content = action_yml.read_text()

        # Claude CLIの統合を確認（"claude"または"claude-code"の言及）
        if "claude" in content.lower():
            actions_with_claude.append(action_dir.name)
        else:
            actions_without_claude.append(action_dir.name)

    passed = len(actions_with_claude) > 0

    return VerificationResult(
        function_id="CF-002",
        function_name="Claude Code CLIを活用した高度な自動化",
        passed=passed,
        details=f"Claude CLI統合あり: {len(actions_with_claude)}/{len(actions_with_claude) + len(actions_without_claude)}",
        evidence=actions_with_claude,
        interpretation=f"{len(actions_with_claude)}個のActionでClaude CLI統合が確認された" if passed else "Claude CLI統合が検出されなかった"
    )

def verify_cf004_dry_run_implementation() -> VerificationResult:
    """CF-004: Dry Run検証の実装状況"""
    actions_dir = Path("actions")
    actions_with_dryrun = []
    actions_without_dryrun = []

    for action_dir in actions_dir.iterdir():
        if not action_dir.is_dir():
            continue

        action_yml = action_dir / "action.yml"
        if not action_yml.exists():
            continue

        content = action_yml.read_text()

        # dry-run入力の存在確認
        has_dry_run_input = (
            "dry-run" in content or
            "dry_run" in content or
            "dryrun" in content or
            "DRY_RUN" in content
        )

        if has_dry_run_input:
            actions_with_dryrun.append(action_dir.name)
        else:
            actions_without_dryrun.append(action_dir.name)

    passed = len(actions_without_dryrun) == 0

    return VerificationResult(
        function_id="CF-004",
        function_name="Dry Run検証の実装",
        passed=passed,
        details=f"Dry Run実装あり: {len(actions_with_dryrun)}/{len(actions_with_dryrun) + len(actions_without_dryrun)}",
        evidence={
            "implemented": actions_with_dryrun,
            "not_implemented": actions_without_dryrun
        },
        interpretation="全ActionでDry Run検証が実装されている" if passed else f"{len(actions_without_dryrun)}個のActionでDry Run検証が未実装: {actions_without_dryrun}"
    )

def verify_cf005_telemetry() -> VerificationResult:
    """CF-005: テレメトリー収集機能"""
    telemetry_script = Path("scripts/collect_metrics.py")

    if telemetry_script.exists():
        content = telemetry_script.read_text()
        has_anon = "anonymize" in content.lower() or "hashlib" in content
        has_optout = "DISABLE_TELEMETRY" in content or "opt" in content.lower()

        passed = has_anon and has_optout

        return VerificationResult(
            function_id="CF-005",
            function_name="テレメトリー収集機能",
            passed=passed,
            details=f"匿名化: {'あり' if has_anon else 'なし'}, オプトアウト: {'あり' if has_optout else 'なし'}",
            evidence=["scripts/collect_metrics.py"],
            interpretation="テレメトリー収集機能が実装され、匿名化とオプトアウト機能を備えている" if passed else "テレメトリー収集機能に不足がある"
        )
    else:
        return VerificationResult(
            function_id="CF-005",
            function_name="テレメトリー収集機能",
            passed=False,
            details="テレメトリースクリプトが存在しない",
            evidence=[],
            interpretation="scripts/collect_metrics.pyが見つからない"
        )

def main():
    """全Core Functionを検証し、レポートを生成"""

    results = [
        verify_cf001_actions_count(),
        verify_cf002_claude_cli_integration(),
        verify_cf004_dry_run_implementation(),
        verify_cf005_telemetry(),
    ]

    # レポート生成
    print("=" * 80)
    print("CORE FUNCTION VERIFICATION REPORT")
    print("=" * 80)
    print()

    passed_count = sum(1 for r in results if r.passed)
    total_count = len(results)

    for r in results:
        status = "✅ PASS" if r.passed else "❌ FAIL"
        print(f"{status} [{r.function_id}] {r.function_name}")
        print(f"  詳細: {r.details}")
        print(f"  解釈: {r.interpretation}")
        if r.evidence:
            if isinstance(r.evidence, dict):
                for key, val in r.evidence.items():
                    if val:
                        print(f"  証拠 ({key}): {val}")
            elif isinstance(r.evidence, list):
                if len(r.evidence) <= 5:
                    print(f"  証拠: {', '.join(r.evidence)}")
                else:
                    print(f"  証拠: {', '.join(r.evidence[:5])} ... (他{len(r.evidence)-5}件)")
        print()

    print("=" * 80)
    print(f"SUMMARY: {passed_count}/{total_count} passed")
    print()

    if passed_count == total_count:
        print("判定: ✅ リポジトリの存在意義が検証された")
    else:
        print("判定: ⚠️  一部のCore Functionsが未達成または未検証")
        print()
        print("次のアクション:")
        for r in results:
            if not r.passed:
                print(f"  - {r.function_id}: {r.interpretation}")

    print("=" * 80)

    # 結果をJSONで保存
    output_path = Path(".audit/output/verification_result.json")
    output_path.parent.mkdir(parents=True, exist_ok=True)

    # Convert dataclass to dict for JSON serialization
    results_dict = [
        {
            **asdict(r),
            'evidence': r.evidence if isinstance(r.evidence, (list, dict)) else [r.evidence]
        }
        for r in results
    ]

    output_path.write_text(json.dumps(results_dict, ensure_ascii=False, indent=2))
    print(f"\n検証結果を保存しました: {output_path}")

    return 0 if passed_count == total_count else 1

if __name__ == "__main__":
    sys.exit(main())
