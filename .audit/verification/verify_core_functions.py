#!/usr/bin/env python3
"""
Core Function Verification Script for AI Hub GitHub Actions
Generated by Repo Genesis Auditor v2.0

This script verifies the core functions claimed in README.md by testing:
1. YAML syntax validity
2. Structural completeness
3. Required field presence
4. Documentation completeness
"""

import json
import sys
import subprocess
from pathlib import Path
from dataclasses import dataclass, asdict
from typing import Any, List, Dict

@dataclass
class VerificationResult:
    """çµæœã‚’æ ¼ç´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""
    function_id: str
    function_name: str
    category: str
    passed: bool
    score: int  # 0-100
    actual_output: Any
    expected_output: Any
    error_message: str | None = None
    interpretation: str = ""
    details: Dict[str, Any] = None

    def __post_init__(self):
        if self.details is None:
            self.details = {}


def verify_yaml_syntax(action_path: Path) -> VerificationResult:
    """CF-YAML: action.ymlãŒæœ‰åŠ¹ãªYAMLæ§‹æ–‡ã§ã‚ã‚‹"""
    action_name = action_path.parent.name
    yaml_file = action_path / "action.yml"

    try:
        # YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        result = subprocess.run(
            ["python3", "-c", f"import yaml; yaml.safe_load(open('{yaml_file}'))"],
            capture_output=True,
            text=True,
            timeout=5
        )

        if result.returncode == 0:
            return VerificationResult(
                function_id="CF-YAML",
                function_name=action_name,
                category="yaml_syntax",
                passed=True,
                score=100,
                actual_output="Valid YAML",
                expected_output="Valid YAML",
                interpretation=f"âœ… {action_name}/action.yml ã¯æœ‰åŠ¹ãªYAMLæ§‹æ–‡"
            )
        else:
            return VerificationResult(
                function_id="CF-YAML",
                function_name=action_name,
                category="yaml_syntax",
                passed=False,
                score=0,
                actual_output=result.stderr,
                expected_output="Valid YAML",
                error_message=result.stderr,
                interpretation=f"âŒ {action_name}/action.yml ã«YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
            )

    except Exception as e:
        return VerificationResult(
            function_id="CF-YAML",
            function_name=action_name,
            category="yaml_syntax",
            passed=False,
            score=0,
            actual_output=str(e),
            expected_output="Valid YAML",
            error_message=str(e),
            interpretation=f"âš ï¸ {action_name}/action.yml ã®æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼"
        )


def verify_required_fields(action_path: Path) -> VerificationResult:
    """CF-STRUCT: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆname, descriptionï¼‰ãŒå­˜åœ¨ã™ã‚‹"""
    action_name = action_path.parent.name
    yaml_file = action_path / "action.yml"

    try:
        import yaml
        with open(yaml_file) as f:
            data = yaml.safe_load(f)

        missing_fields = []
        required_fields = ["name", "description"]

        for field in required_fields:
            if field not in data or not data[field]:
                missing_fields.append(field)

        if not missing_fields:
            return VerificationResult(
                function_id="CF-STRUCT",
                function_name=action_name,
                category="structure",
                passed=True,
                score=100,
                actual_output=data.get("name", "N/A"),
                expected_output="name, description present",
                details={
                    "name": data.get("name"),
                    "description": data.get("description")[:100] if data.get("description") else None
                },
                interpretation=f"âœ… {action_name} ã¯å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã™ã¹ã¦æŒã¤"
            )
        else:
            return VerificationResult(
                function_id="CF-STRUCT",
                function_name=action_name,
                category="structure",
                passed=False,
                score=50,
                actual_output=f"Missing: {missing_fields}",
                expected_output="name, description present",
                error_message=f"Missing fields: {missing_fields}",
                interpretation=f"âš ï¸ {action_name} ã¯å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¬ ã„ã¦ã„ã‚‹: {missing_fields}"
            )

    except Exception as e:
        return VerificationResult(
            function_id="CF-STRUCT",
            function_name=action_name,
            category="structure",
            passed=False,
            score=0,
            actual_output=str(e),
            expected_output="name, description present",
            error_message=str(e),
            interpretation=f"âŒ {action_name} ã®æ§‹é€ æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}"
        )


def verify_composite_action_type(action_path: Path) -> VerificationResult:
    """CF-TYPE: Composite Actionã¨ã—ã¦æ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹"""
    action_name = action_path.parent.name
    yaml_file = action_path / "action.yml"

    try:
        import yaml
        with open(yaml_file) as f:
            data = yaml.safe_load(f)

        runs_config = data.get("runs", {})
        using = runs_config.get("using", "")

        if using == "composite":
            steps = runs_config.get("steps", [])
            return VerificationResult(
                function_id="CF-TYPE",
                function_name=action_name,
                category="type",
                passed=True,
                score=100,
                actual_output=f"composite with {len(steps)} steps",
                expected_output="composite",
                details={
                    "steps_count": len(steps),
                    "has_steps": len(steps) > 0
                },
                interpretation=f"âœ… {action_name} ã¯æ­£ã—ã„Composite Actionï¼ˆ{len(steps)} stepsï¼‰"
            )
        else:
            return VerificationResult(
                function_id="CF-TYPE",
                function_name=action_name,
                category="type",
                passed=False,
                score=0,
                actual_output=using,
                expected_output="composite",
                error_message=f"Not a composite action: {using}",
                interpretation=f"âŒ {action_name} ã¯Composite Actionã§ã¯ãªã„ï¼ˆ{using}ï¼‰"
            )

    except Exception as e:
        return VerificationResult(
            function_id="CF-TYPE",
            function_name=action_name,
            category="type",
            passed=False,
            score=0,
            actual_output=str(e),
            expected_output="composite",
            error_message=str(e),
            interpretation=f"âŒ {action_name} ã®ã‚¿ã‚¤ãƒ—æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}"
        )


def verify_documentation(action_path: Path, examples_dir: Path, instructions_dir: Path) -> VerificationResult:
    """CF-DOC: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆexample, instructionï¼‰ãŒå­˜åœ¨ã™ã‚‹"""
    action_name = action_path.parent.name

    example_file = examples_dir / f"{action_name}.yml"
    instruction_file = instructions_dir / f"{action_name}.md"

    has_example = example_file.exists()
    has_instruction = instruction_file.exists()

    score = 0
    if has_example:
        score += 50
    if has_instruction:
        score += 50

    passed = score == 100

    return VerificationResult(
        function_id="CF-DOC",
        function_name=action_name,
        category="documentation",
        passed=passed,
        score=score,
        actual_output={
            "example": has_example,
            "instruction": has_instruction
        },
        expected_output={
            "example": True,
            "instruction": True
        },
        details={
            "example_path": str(example_file) if has_example else None,
            "instruction_path": str(instruction_file) if has_instruction else None
        },
        interpretation=(
            f"âœ… {action_name} ã¯å®Œå…¨ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒã¤" if passed
            else f"âš ï¸ {action_name} ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä¸å®Œå…¨ï¼ˆexample:{has_example}, instruction:{has_instruction}ï¼‰"
        )
    )


def verify_test_coverage(action_path: Path, tests_dir: Path) -> VerificationResult:
    """CF-TEST: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹"""
    action_name = action_path.parent.name
    test_dir = tests_dir / f"test_{action_name}"

    has_test = test_dir.exists() and test_dir.is_dir()

    # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    test_files = 0
    if has_test:
        test_files = len(list(test_dir.glob("test_*.py")))

    score = 100 if test_files > 0 else 0

    return VerificationResult(
        function_id="CF-TEST",
        function_name=action_name,
        category="testing",
        passed=score > 0,
        score=score,
        actual_output={
            "has_test_dir": has_test,
            "test_files_count": test_files
        },
        expected_output={
            "has_test_dir": True,
            "test_files_count": ">= 1"
        },
        details={
            "test_dir_path": str(test_dir) if has_test else None,
            "test_files": test_files
        },
        interpretation=(
            f"âœ… {action_name} ã¯ãƒ†ã‚¹ãƒˆã‚’æŒã¤ï¼ˆ{test_files} filesï¼‰" if test_files > 0
            else f"âŒ {action_name} ã¯ãƒ†ã‚¹ãƒˆãŒãªã„"
        )
    )


def main():
    """ãƒ¡ã‚¤ãƒ³æ¤œè¨¼ãƒ•ãƒ­ãƒ¼"""
    repo_root = Path(__file__).parent.parent.parent
    actions_dir = repo_root / "actions"
    examples_dir = repo_root / "examples"
    instructions_dir = repo_root / "instructions"
    tests_dir = repo_root / "tests"

    print("=" * 80)
    print("CORE FUNCTION VERIFICATION REPORT")
    print("=" * 80)
    print(f"Target Repository: {repo_root}")
    print(f"Actions Directory: {actions_dir}")
    print()

    # å…¨Actionã‚’æ¤œè¨¼
    all_results = []

    for action_path in sorted(actions_dir.glob("*/")):
        if not (action_path / "action.yml").exists():
            continue

        action_name = action_path.name
        print(f"\nğŸ“¦ Verifying: {action_name}")
        print("-" * 80)

        # å„æ¤œè¨¼ã‚’å®Ÿè¡Œ
        verifications = [
            verify_yaml_syntax(action_path),
            verify_required_fields(action_path),
            verify_composite_action_type(action_path),
            verify_documentation(action_path, examples_dir, instructions_dir),
            verify_test_coverage(action_path, tests_dir),
        ]

        all_results.extend(verifications)

        # çµæœè¡¨ç¤º
        for result in verifications:
            status = "âœ… PASS" if result.passed else "âŒ FAIL"
            print(f"  {status} [{result.function_id}] {result.category}")
            print(f"     è§£é‡ˆ: {result.interpretation}")
            if result.error_message and not result.passed:
                print(f"     ã‚¨ãƒ©ãƒ¼: {result.error_message[:100]}")

    # é›†è¨ˆ
    print("\n" + "=" * 80)
    print("SUMMARY BY CATEGORY")
    print("=" * 80)

    categories = {}
    for result in all_results:
        if result.category not in categories:
            categories[result.category] = {"passed": 0, "total": 0}
        categories[result.category]["total"] += 1
        if result.passed:
            categories[result.category]["passed"] += 1

    for category, stats in sorted(categories.items()):
        passed = stats["passed"]
        total = stats["total"]
        percentage = (passed / total * 100) if total > 0 else 0
        print(f"{category:20s}: {passed:2d}/{total:2d} ({percentage:5.1f}%)")

    # å…¨ä½“ã‚¹ã‚³ã‚¢
    print("\n" + "=" * 80)
    print("OVERALL SCORE")
    print("=" * 80)

    total_passed = sum(1 for r in all_results if r.passed)
    total_tests = len(all_results)
    overall_percentage = (total_passed / total_tests * 100) if total_tests > 0 else 0

    print(f"Total: {total_passed}/{total_tests} passed ({overall_percentage:.1f}%)")

    if overall_percentage >= 80:
        print("åˆ¤å®š: âœ… ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ã‚¢æ©Ÿèƒ½ã¯å¤§éƒ¨åˆ†æ¤œè¨¼ã•ã‚ŒãŸ")
        exit_code = 0
    elif overall_percentage >= 50:
        print("åˆ¤å®š: âš ï¸ ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ã‚¢æ©Ÿèƒ½ã¯éƒ¨åˆ†çš„ã«æ¤œè¨¼ã•ã‚ŒãŸ")
        exit_code = 1
    else:
        print("åˆ¤å®š: âŒ ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ã‚¢æ©Ÿèƒ½ã¯æ¤œè¨¼ã•ã‚Œã¦ã„ãªã„")
        exit_code = 2

    # JSONå‡ºåŠ›
    output_path = Path(__file__).parent.parent / "output" / "verification_result.json"
    output_path.parent.mkdir(parents=True, exist_ok=True)

    output_data = {
        "summary": {
            "total_tests": total_tests,
            "passed": total_passed,
            "failed": total_tests - total_passed,
            "percentage": round(overall_percentage, 1),
            "verdict": "PASS" if exit_code == 0 else "FAIL" if exit_code == 2 else "CONDITIONAL"
        },
        "categories": categories,
        "results": [asdict(r) for r in all_results]
    }

    output_path.write_text(json.dumps(output_data, ensure_ascii=False, indent=2))
    print(f"\nğŸ“„ Detailed results saved to: {output_path}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
