#!/usr/bin/env python3
"""
Core Function Verification Script for GitHub Actions Actions Hub
Generated by Repo Genesis Auditor v2.0

This script verifies the core functions claimed by the repository:
1. AI PR review and auto-fix (CF-001)
2. Markdown spec to code generation (CF-002)
3. Auto-documentation updates (CF-003)
4. Action workflow error fixing (CF-004)
5. Test coverage >= 70% (CF-005)
6. Test count (CF-006)
"""

import subprocess
import sys
import json
from pathlib import Path
from dataclasses import dataclass, asdict
from typing import Any, Optional


@dataclass
class VerificationResult:
    function_id: str
    scenario_name: str
    passed: bool
    actual_output: Any
    expected_output: Any
    error_message: Optional[str] = None
    interpretation: str = ""
    evidence_files: list = None

    def __post_init__(self):
        if self.evidence_files is None:
            self.evidence_files = []


def verify_cf001_action_structure() -> VerificationResult:
    """CF-001: review-and-merge Action が存在し、適切な構造を持っている"""
    repo_root = Path("/home/jinno/github-actions-actions")
    action_path = repo_root / "actions" / "review-and-merge"
    action_yml = action_path / "action.yml"
    readme = action_path / "README.md"

    issues = []

    # Check action.yml exists
    if not action_yml.exists():
        issues.append("action.yml not found")

    # Check README exists
    if not readme.exists():
        issues.append("README.md not found")

    # Check instruction file exists
    instruction = repo_root / "instructions" / "review-and-merge.md"
    if not instruction.exists():
        issues.append("instructions/review-and-merge.md not found")

    # Check example workflow exists
    example = repo_root / "examples" / "review-and-merge.yml"
    if not example.exists():
        issues.append("examples/review-and-merge.yml not found")

    passed = len(issues) == 0

    return VerificationResult(
        function_id="CF-001",
        scenario_name="review-and-merge Action構造検証",
        passed=passed,
        actual_output=f"Found issues: {issues}" if issues else "All required files present",
        expected_output="action.yml, README.md, instructions/*.md, examples/*.yml が存在する",
        interpretation=(
            "review-and-merge Actionは完全に構築されている" if passed
            else f"欠落ファイル: {', '.join(issues)}"
        ),
        evidence_files=[str(action_yml), str(readme), str(instruction), str(example)]
    )


def verify_cf002_spec_to_code_structure() -> VerificationResult:
    """CF-002: spec-to-code Action が存在し、適切な構造を持っている"""
    repo_root = Path("/home/jinno/github-actions-actions")
    action_path = repo_root / "actions" / "spec-to-code"
    action_yml = action_path / "action.yml"

    if not action_path.exists():
        return VerificationResult(
            function_id="CF-002",
            scenario_name="spec-to-code Action構造検証",
            passed=False,
            actual_output="actions/spec-to-code directory not found",
            expected_output="actions/spec-to-code/ が存在する",
            interpretation="spec-to-code Actionが未実装",
        )

    issues = []

    if not action_yml.exists():
        issues.append("action.yml not found")

    # Check for spec-to-code specific files
    scripts_dir = action_path / "scripts"
    if not scripts_dir.exists():
        issues.append("scripts/ directory not found")

    passed = len(issues) == 0

    return VerificationResult(
        function_id="CF-002",
        scenario_name="spec-to-code Action構造検証",
        passed=passed,
        actual_output=f"Found issues: {issues}" if issues else "Structure verified",
        expected_output="actions/spec-to-code/ に必要なファイルが存在する",
        interpretation=(
            "spec-to-code Actionは実装されている" if passed
            else f"欠落: {', '.join(issues)}"
        ),
        evidence_files=[str(action_yml), str(scripts_dir)]
    )


def verify_cf003_auto_document_structure() -> VerificationResult:
    """CF-003: auto-document Action が存在し、適切な構造を持っている"""
    repo_root = Path("/home/jinno/github-actions-actions")
    action_path = repo_root / "actions" / "auto-document"
    action_yml = action_path / "action.yml"

    if not action_path.exists():
        return VerificationResult(
            function_id="CF-003",
            scenario_name="auto-document Action構造検証",
            passed=False,
            actual_output="actions/auto-document directory not found",
            expected_output="actions/auto-document/ が存在する",
            interpretation="auto-document Actionが未実装",
        )

    issues = []

    if not action_yml.exists():
        issues.append("action.yml not found")

    instruction = repo_root / "instructions" / "auto-document.md"
    if not instruction.exists():
        issues.append("instructions/auto-document.md not found")

    passed = len(issues) == 0

    return VerificationResult(
        function_id="CF-003",
        scenario_name="auto-document Action構造検証",
        passed=passed,
        actual_output=f"Found issues: {issues}" if issues else "Structure verified",
        expected_output="actions/auto-document/ と導入ドキュメントが存在する",
        interpretation=(
            "auto-document Actionは実装されている" if passed
            else f"欠落: {', '.join(issues)}"
        ),
        evidence_files=[str(action_yml), str(instruction)]
    )


def verify_cf004_action_fixer_structure() -> VerificationResult:
    """CF-004: action-fixer Action が存在し、適切な構造を持っている"""
    repo_root = Path("/home/jinno/github-actions-actions")
    action_path = repo_root / "actions" / "action-fixer"
    action_yml = action_path / "action.yml"

    if not action_path.exists():
        return VerificationResult(
            function_id="CF-004",
            scenario_name="action-fixer Action構造検証",
            passed=False,
            actual_output="actions/action-fixer directory not found",
            expected_output="actions/action-fixer/ が存在する",
            interpretation="action-fixer Actionが未実装",
        )

    issues = []

    if not action_yml.exists():
        issues.append("action.yml not found")

    # Check for YAML validation scripts
    scripts_dir = action_path / "scripts"
    if scripts_dir.exists():
        scripts = list(scripts_dir.glob("*.py"))
        if len(scripts) == 0:
            issues.append("No Python scripts found in scripts/")
    else:
        issues.append("scripts/ directory not found")

    passed = len(issues) == 0

    return VerificationResult(
        function_id="CF-004",
        scenario_name="action-fixer Action構造検証",
        passed=passed,
        actual_output=f"Found issues: {issues}" if issues else "Structure verified",
        expected_output="actions/action-fixer/ に検証スクリプトが存在する",
        interpretation=(
            "action-fixer Actionは実装されている" if passed
            else f"欠落: {', '.join(issues)}"
        ),
        evidence_files=[str(action_yml), str(scripts_dir)]
    )


def verify_cf005_test_coverage() -> VerificationResult:
    """CF-005: テストカバレッジ >= 70% を達成している"""
    repo_root = Path("/home/jinno/github-actions-actions")

    try:
        # Run pytest with coverage
        result = subprocess.run(
            ["pytest", "--cov=.", "--cov-report=json", "--cov-report=term", "-q"],
            cwd=repo_root,
            capture_output=True,
            text=True,
            timeout=300
        )

        # Read coverage.json
        coverage_json = repo_root / "coverage.json"
        if coverage_json.exists():
            with open(coverage_json) as f:
                coverage_data = json.load(f)
            total_coverage = coverage_data["totals"]["percent_covered"]

            passed = total_coverage >= 70.0

            return VerificationResult(
                function_id="CF-005",
                scenario_name="テストカバレッジ >= 70% 達成確認",
                passed=passed,
                actual_output=f"{total_coverage:.1f}%",
                expected_output=">= 70%",
                interpretation=(
                    f"テストカバレッジ {total_coverage:.1f}% は目標を達成している" if passed
                    else f"テストカバレッジ {total_coverage:.1f}% は目標の70%を下回っている"
                ),
                evidence_files=[str(coverage_json)]
            )
        else:
            # Parse from terminal output if JSON not available
            output = result.stdout + result.stderr
            # Look for coverage percentage in output
            import re
            match = re.search(r'TOTAL\s+\d+\s+\d+\s+(\d+)%', output)
            if match:
                coverage = int(match.group(1))
                passed = coverage >= 70

                return VerificationResult(
                    function_id="CF-005",
                    scenario_name="テストカバレッジ >= 70% 達成確認",
                    passed=passed,
                    actual_output=f"{coverage}%",
                    expected_output=">= 70%",
                    interpretation=(
                        f"テストカバレッジ {coverage}% は目標を達成している" if passed
                        else f"テストカバレッジ {coverage}% は目標の70%を下回っている"
                    ),
                )
            else:
                return VerificationResult(
                    function_id="CF-005",
                    scenario_name="テストカバレッジ >= 70% 達成確認",
                    passed=False,
                    actual_output="Coverage measurement failed",
                    expected_output=">= 70%",
                    interpretation="カバレッジ測定に失敗。pytest出力を確認してください。",
                    error_message="coverage.json not found and no coverage in output"
                )

    except subprocess.TimeoutExpired:
        return VerificationResult(
            function_id="CF-005",
            scenario_name="テストカバレッジ >= 70% 達成確認",
            passed=False,
            actual_output="Timeout",
            expected_output=">= 70%",
            interpretation="テスト実行がタイムアウトした。テストスイートが重すぎる可能性。",
            error_message="pytest execution timed out after 300 seconds"
        )
    except Exception as e:
        return VerificationResult(
            function_id="CF-005",
            scenario_name="テストカバレッジ >= 70% 達成確認",
            passed=False,
            actual_output=str(e),
            expected_output=">= 70%",
            interpretation="カバレッジ測定中にエラーが発生",
            error_message=str(e)
        )


def verify_cf006_test_count() -> VerificationResult:
    """CF-006: 301のテストケースが存在する"""
    repo_root = Path("/home/jinno/github-actions-actions")

    try:
        result = subprocess.run(
            ["pytest", "--collect-only", "-q"],
            cwd=repo_root,
            capture_output=True,
            text=True,
            timeout=60
        )

        output = result.stdout + result.stderr

        # Parse test count from pytest output
        import re
        match = re.search(r'collected\s+(\d+)\s+items', output)

        if match:
            test_count = int(match.group(1))
            expected_count = 301
            passed = test_count >= expected_count  # Allow more tests

            return VerificationResult(
                function_id="CF-006",
                scenario_name="テストケース数 >= 301 確認",
                passed=passed,
                actual_output=f"{test_count} tests",
                expected_output=f">= {expected_count} tests",
                interpretation=(
                    f"テストケース数 {test_count} は目標の{expected_count}件以上を満たしている" if passed
                    else f"テストケース数 {test_count} は目標の{expected_count}件を下回っている"
                ),
            )
        else:
            return VerificationResult(
                function_id="CF-006",
                scenario_name="テストケース数 >= 301 確認",
                passed=False,
                actual_output="Parse failed",
                expected_output=">= 301 tests",
                interpretation="pytest出力からテスト数を取得できなかった",
                error_message="Could not parse test count from pytest output"
            )

    except Exception as e:
        return VerificationResult(
            function_id="CF-006",
            scenario_name="テストケース数 >= 301 確認",
            passed=False,
            actual_output=str(e),
            expected_output=">= 301 tests",
            interpretation="テスト収集中にエラーが発生",
            error_message=str(e)
        )


def main():
    """全Core Functionを検証し、レポートを生成"""

    print("=" * 70)
    print("CORE FUNCTION VERIFICATION REPORT")
    print("GitHub Actions Actions Hub")
    print("=" * 70)

    results = [
        verify_cf001_action_structure(),
        verify_cf002_spec_to_code_structure(),
        verify_cf003_auto_document_structure(),
        verify_cf004_action_fixer_structure(),
        verify_cf005_test_coverage(),
        verify_cf006_test_count(),
    ]

    # Print results
    passed_count = sum(1 for r in results if r.passed)
    total_count = len(results)

    for r in results:
        status = "✅ PASS" if r.passed else "❌ FAIL"
        print(f"\n{status} [{r.function_id}] {r.scenario_name}")
        print(f"  期待値: {r.expected_output}")
        print(f"  実測値: {r.actual_output}")
        print(f"  解釈: {r.interpretation}")
        if r.error_message:
            print(f"  エラー: {r.error_message}")

    print("\n" + "=" * 70)
    print(f"SUMMARY: {passed_count}/{total_count} passed ({passed_count*100//total_count}%)")

    if passed_count == total_count:
        print("判定: ✅ リポジトリの存在意義が検証された")
        print("\n全てのコア機能が期待通りに動作しています。")
    else:
        print("判定: ⚠️  存在意義の一部に課題がある")
        print("\n改善が必要な項目:")
        for r in results:
            if not r.passed:
                print(f"  - {r.function_id}: {r.interpretation}")

    # Save results to JSON
    output_path = Path("/home/jinno/github-actions-actions/.audit/output/verification_result.json")
    output_path.parent.mkdir(parents=True, exist_ok=True)

    # Convert dataclass to dict for JSON serialization
    results_dict = []
    for r in results:
        r_dict = asdict(r)
        # Remove None values for cleaner JSON
        r_dict = {k: v for k, v in r_dict.items() if v is not None}
        results_dict.append(r_dict)

    output_path.write_text(
        json.dumps(results_dict, ensure_ascii=False, indent=2),
        encoding='utf-8'
    )

    print(f"\n詳細なレポートを保存しました: {output_path}")

    sys.exit(0 if passed_count == total_count else 1)


if __name__ == "__main__":
    main()
