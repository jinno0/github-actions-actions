# PR-002: Enhanced Dry-Run Validation

**Status**: Ready to implement
**Priority**: High (ISS-003)
**Effort**: 2-4 hours
**Risk**: Low

## Problem Statement

Current CI validation (test-all-actions.yml) only checks:
- File structure (action.yml, example.yml, instruction.md exist)
- YAML syntax validity

**It does NOT verify**:
- Actions can execute without errors
- Templates substitute correctly
- Claude CLI integration works
- Actions produce expected outputs

**Impact**: Broken actions may pass CI and reach production.

## Solution

Add functional dry-run validation that executes each AI action with `dry_run: true` and verifies:
1. Exit code = 0 (success)
2. No error messages in output
3. Expected output patterns present

## Changes

### 1. Create `.github/workflows/test-with-dry-run.yml`

```yaml
name: Test Actions with Dry Run
on:
  pull_request:
    paths:
      - 'actions/**'
      - '.github/workflows/test-with-dry-run.yml'
  push:
    branches: [main]
    paths:
      - 'actions/**'

jobs:
  dry-run-test:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        action:
          - review-and-merge
          - spec-to-code
          - action-fixer
          - auto-refactor
          - auto-document
          - release-notes-ai
          - auto-rebase

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Test ${{ matrix.action }} with dry-run
        id: dry-run
        continue-on-error: true
        uses: ./.actions/${{ matrix.action }}
        with:
          dry-run: true
          test-mode: true

      - name: Verify exit code
        if: steps.dry-run.outcome == 'failure'
        run: |
          echo "::error::Action ${{ matrix.action }} failed dry-run validation"
          exit 1

      - name: Dry-run successful
        if: steps.dry-run.outcome == 'success'
        run: |
          echo "::notice::Action ${{ matrix.action }} passed dry-run validation"
```

### 2. Update `.github/workflows/test-all-actions.yml`

Add reference to dry-run workflow:

```yaml
# Add after existing jobs
  dry-run-validation:
    name: Dry-Run Validation
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dry-run workflow
        run: |
          echo "Dry-run validation is run separately in test-with-dry-run.yml"
          echo "This ensures self-hosted runner availability"
```

## Success Criteria

- ✅ All 9 AI actions (7 matrix + 2 special) pass dry-run
- ✅ CI fails if any action returns non-zero exit code
- ✅ Execution time logged for each action
- ✅ No manual intervention required

## Verification

After applying this PR:
1. Create test PR
2. Check that dry-run workflow executes
3. Verify all 9 actions pass
4. Check logs for execution time
5. Confirm CI fails if action broken (intentional test)

## Rollback

If issues arise:
1. Delete `.github/workflows/test-with-dry-run.yml`
2. Remove reference from test-all-actions.yml (if added)
3. No code changes to rollback

## Alternatives Considered

**Alternative A**: Add dry-run to existing test-all-actions.yml
- **Rejected**: Self-hosted runner contention - structure tests fast, dry-run slow
- **Decision**: Separate workflow allows parallel execution without blocking structure tests

**Alternative B**: Use mock Claude CLI
- **Rejected**: Doesn't test actual integration
- **Decision**: Real dry-run with Claude CLI provides authentic validation

## Risks & Mitigations

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Dry-run exposes hidden bugs | Medium | Low | Finding bugs is the goal |
| Self-hosted runner unavailable | Low | Medium | Workflow is optional for merges |
| False positives | Low | Medium | Manual review if fails |

## Dependencies

- Requires self-hosted runner with Claude CLI
- Requires action.yml to support `dry_run` input
- Requires action.yml to support `test_mode` input

## Related Issues

- Closes ISS-003 (High severity)
- Addresses feedback_to_auditor.yml ISS-DISC-003
- Supports QA-001 (Dry Run検証カバレッジ)

## Notes

Utility actions (auto-merge, bulk-merge-prs, etc.) excluded because:
- They wrap gh CLI (no AI prompts)
- Already tested by structure validation
- Don't have dry-run mode (by design)

Total dry-run time: ~5-10 minutes (9 actions × 30-60s each)

---

**Ready for implementation**
