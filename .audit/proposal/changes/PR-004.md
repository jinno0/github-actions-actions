# PR-004: Enable Test Coverage Measurement

**Status**: Ready to implement
**Priority**: High (ISS-004)
**Effort**: 1-2 hours
**Risk**: Low

## Problem Statement

Repository contains Python helper scripts in `.claude/skills/` and `tests/`, but:
- Actual test coverage percentage is unknown
- No coverage thresholds defined
- Cannot measure quality improvement over time
- May have untested critical paths

**Impact**: Quality is not measurable or improvable.

## Solution

Enable pytest-cov to:
1. Measure actual test coverage
2. Set minimum threshold (60% initial, 80% target)
3. Generate coverage reports (terminal + HTML)
4. Track coverage trends over time

## Changes

### 1. Update `pytest.ini`

```ini
[pytest]
testpaths = tests
python_files = test_*.py
addopts =
    --cov=.claude/skills
    --cov=tests
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=json:coverage.json
    --cov-fail-under=60
```

**Changes**:
- Add `--cov` flags for .claude/skills and tests/
- Add terminal report with missing lines
- Add HTML report for detailed viewing
- Add JSON report for trend tracking
- Set fail threshold at 60% (conservative initial value)

### 2. Update `.github/workflows/test-all-actions.yml`

Add coverage step after existing tests:

```yaml
# .github/workflows/test-all-actions.yml

jobs:
  test:
    # ... existing steps ...

    - name: Run tests with coverage
      run: |
        pip install pytest-cov
        pytest --cov=.claude/skills --cov-report=xml --cov-report=term

    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.json
        retention-days: 30

    - name: Comment coverage on PR (optional)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
          const pct = coverage.total.lines.pct;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `### Test Coverage: ${pct.toFixed(1)}%\\n\\n[View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          });
```

### 3. Create `.gitignore` Entry (if not exists)

```
# Coverage reports
htmlcov/
.coverage
coverage.json
*.cover
```

### 4. Create `tests/conftest.py` (if not exists)

```python
"""Pytest configuration and fixtures."""
import pytest

@pytest.fixture
def sample_context():
    """Sample action context for testing."""
    return {
        "repo": "test/repo",
        "pr_number": 123,
        "branch": "feature/test"
    }
```

## Success Criteria

- ✅ Coverage report generated on each test run
- ✅ CI fails if coverage < 60%
- ✅ HTML report available as workflow artifact
- ✅ Terminal report shows missing lines
- ✅ Coverage percentage visible in PR comments

## Verification

After applying this PR:
1. Run `pytest` locally
2. Verify terminal output shows coverage percentage
3. Open `htmlcov/index.html` in browser
4. Check that CI uploads coverage artifacts
5. Create test PR and verify coverage comment
6. Intentionally reduce coverage to verify threshold enforcement

## Rollback

If issues arise:
1. Comment out `--cov*` lines in pytest.ini
2. Remove coverage upload step from CI
3. Delete coverage artifacts from workflow runs
4. No code changes to rollback

## Alternatives Considered

**Alternative A**: Set initial threshold at 80%
- **Rejected**: May fail CI immediately if current coverage is lower
- **Decision**: Start at 60%, measure baseline, then increase to 80%

**Alternative B**: Use coverage.py instead of pytest-cov
- **Rejected**: pytest-cov integrates better with pytest workflow
- **Decision**: pytest-cov is standard choice for pytest projects

**Alternative C**: Only measure, don't fail CI
- **Rejected**: No incentive to maintain or improve coverage
- **Decision**: Fail threshold ensures quality doesn't regress

## Risks & Mitigations

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Current coverage < 60% | Medium | Medium | Set threshold at actual current % first |
| False sense of security | Low | Low | Coverage ≠ quality - need code review |
| Test execution slower | Low | Low | Coverage adds ~10-20% overhead |

## Dependencies

- Requires pytest (already in use)
- Requires pytest-cov package (add to requirements.txt if needed)

## Requirements Update

Add to `requirements.txt` or `pyproject.toml`:

```
pytest-cov>=4.0.0
```

Or if using pyproject.toml:

```toml
[tool.poetry.dev-dependencies]
pytest-cov = "^4.0.0"
```

## Related Issues

- Closes ISS-004 (High severity)
- Supports quality measurement goal (mission.desired_state)
- Enables data-driven improvement decisions

## Future Enhancements

- Add coverage badge to README
- Integrate with Codecov/Coveralls for trend visualization
- Set per-module coverage thresholds
- Add branch coverage measurement
- Track coverage in .audit/analysis/quality_metrics.yml

## Notes

**Coverage Categories**:
- Lines covered: % of executable lines tested
- Branches covered: % of code branches tested
- Current focus: Line coverage (simpler, sufficient)

**Threshold Rationale**:
- 60%: Conservative baseline - achievable without massive effort
- 80%: Target threshold - indicates good test coverage
- 90%+: Excellent - diminishing returns beyond this

**Estimated Current Coverage**: Unknown (this PR will measure it)

---

**Ready for implementation**
