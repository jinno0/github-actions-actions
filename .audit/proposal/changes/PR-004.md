# PR-004: Diagnose and Document Review Data Collection Issue

**Generated:** 2026-02-07T06:17:33Z
**Addresses:** ISS-NEW-001 (レビューデータ収集プロセスが稼働していない)
**Priority:** HIGH
**Phase:** Pre-Phase 2
**Estimated Effort:** 2-4 hours

---

## Problem Statement

The file `metrics/review_metrics.json` does not exist, indicating that review data collection is not working. This prevents baseline acceptance rate calculation and blocks GAP-001 completion.

**Impact:**
- Cannot calculate actual baseline acceptance rate
- Cannot measure AI review quality improvements
- Cannot generate automated weekly reports
- Cannot perform false positive analysis (Phase 4)

---

## Diagnosis

### 1. Verify Expected File Locations

**Status:** ✅ Confirmed missing

```bash
$ ls -la metrics/review_metrics.json
ls: cannot access 'metrics/review_metrics.json': No such file or directory
```

### 2. Check review-and-merge Action Configuration

Let me examine the action to understand how it should collect metrics:

**File:** `actions/review-and-merge/action.yml`

**Expected behavior:**
- Action should write review outcomes to `metrics/review_metrics.json`
- Environment variable `REVIEW_METRICS_FILE` should control output location
- Workflow permissions should allow writing to the metrics file

### 3. Identify Data Collection Flow

**Expected Flow:**
```
1. PR opens in pilot project
2. review-and-merge Action triggers
3. Claude generates review
4. Developer applies/modifies/rejects review suggestions
5. Action records outcome to metrics/review_metrics.json
6. Weekly workflow reads file and generates report
```

**Current Flow (BROKEN):**
```
1. PR opens in pilot project
2. review-and-merge Action triggers (?) - UNVERIFIED
3. Claude generates review (?)
4. Developer applies/modifies/rejects review suggestions
5. ❌ NO DATA WRITTEN TO metrics/review_metrics.json
6. ❌ Weekly workflow has no data to report
```

---

## Root Cause Analysis

### Hypothesis 1: Pilot Projects Not Using Action

**Likelihood:** HIGH (based on ISS-NEW-002 placeholders)

**Evidence:**
- ADOPTION.md shows placeholder repos
- No actual pilot projects verified
- If Actions aren't running, no data is collected

**Verification Required:**
```bash
# For each actual pilot project:
gh repo view ORG/REPO --json workflows
gh workflow list --repo ORG/REPO
gh workflow view review-and-merge --repo ORG/REPO --log
```

### Hypothesis 2: Metrics Writing Not Configured

**Likelihood:** MEDIUM

**Evidence:**
- Action may not have metrics collection enabled
- `REVIEW_METRICS_FILE` environment variable may not be set
- Workflow may lack write permissions

**Verification Required:**
- Check pilot project workflow files for `REVIEW_METRICS_FILE`
- Verify workflow has `contents: write` permission
- Check Action templates for metrics collection code

### Hypothesis 3: Metrics File Path Issue

**Likelihood:** LOW

**Evidence:**
- File path may be relative vs absolute
- Working directory may differ from expected

**Verification Required:**
- Check Action code for file path construction
- Verify GitHub Actions workspace context

---

## Proposed Actions

### Action 1: Create Data Collection Diagnostic Document

**File:** `docs/data_collection_diagnosis.md` (CREATE)

**Content:**
```markdown
# Review Data Collection Diagnosis

**Date:** 2026-02-07
**Issue:** metrics/review_metrics.json does not exist
**Impact:** Cannot calculate baseline acceptance rate

## Current Status

❌ **File Missing:** `metrics/review_metrics.json` does not exist
⚠️ **Pilot Projects:** Unverified (ISS-NEW-002)
❓ **Action Status:** Unknown if running in pilot projects

## Root Cause Hypotheses

### 1. Pilot Projects Not Using Action (HIGH LIKELIHOOD)
- **Evidence:** ADOPTION.md has placeholder repos
- **Impact:** No Action runs = No data collected
- **Resolution Required:** Identify real pilot projects (PR-003)

### 2. Metrics Collection Not Enabled (MEDIUM LIKELIHOOD)
- **Evidence:** Needs verification in pilot project workflows
- **Impact:** Action runs but doesn't save data
- **Resolution Required:** Configure `REVIEW_METRICS_FILE` in workflows

### 3. Permissions Issue (LOW LIKELIHOOD)
- **Evidence:** Needs verification
- **Impact:** Action tries to write but fails silently
- **Resolution Required:** Add `contents: write` permission

## Diagnostic Commands

### For Pilot Project Administrators

Run these commands in each pilot project:

```bash
# 1. Check if review-and-merge workflow exists
gh workflow list --search review-and-merge

# 2. Check workflow runs
gh run list --workflow=review-and-merge.yml --limit 10

# 3. Check workflow configuration
cat .github/workflows/*review*.yml | grep -A 5 -B 5 "REVIEW_METRICS_FILE"

# 4. Check permissions
cat .github/workflows/*review*.yml | grep -A 3 "permissions:"

# 5. Check recent logs for errors
gh run view --log-failed | tail -100
```

## Resolution Steps

### Step 1: Verify Pilot Projects (PR-003)
- [ ] Identify actual repositories using review-and-merge
- [ ] Confirm workflows are enabled
- [ ] Check recent workflow runs

### Step 2: Enable Metrics Collection
If workflows exist but don't collect metrics:

```yaml
# Add to workflow:
env:
  REVIEW_METRICS_FILE: ${{ github.workspace }}/metrics/review_metrics.json

permissions:
  contents: write  # Allow writing to repository
```

### Step 3: Create metrics directory
```bash
mkdir -p metrics
echo '{"reviews":[]}' > metrics/review_metrics.json
git add metrics/
git commit -m "chore: initialize review metrics file"
```

### Step 4: Verify Data Collection
- [ ] Wait for next PR to be reviewed
- [ ] Check that `metrics/review_metrics.json` is updated
- [ ] Verify file contains review data

## Next Actions

1. **Immediate:** Complete PR-003 to identify pilot projects
2. **Short-term:** Work with pilot teams to enable metrics collection
3. **Verification:** After 7 days, check `metrics/review_metrics.json` exists and has data

## Success Criteria

- [ ] Both pilot projects have metrics collection enabled
- [ ] At least 5 reviews collected within 7 days
- [ ] `scripts/calculate_acceptance_rate.py` can read the file
- [ ] Baseline acceptance rate can be calculated

---

**Document Owner:** DevOps Team
**Next Review:** After PR-003 completion or 2026-02-14
```

### Action 2: Update README with Data Collection Status

**File:** `README.md` (MODIFY)

**Location:** In the "現在のベースライン" section

**Add:**
```yaml
additional_notice: |
  ⚠️ **データ収集状況:** `metrics/review_metrics.json` が存在しません。
  パイロットプロジェクトでのレビューデータ収集を有効化する必要があります。
  詳細は [Data Collection Diagnosis](docs/data_collection_diagnosis.md) を参照してください。
```

### Action 3: Create GitHub Issue Tracking Resolution

**File:** Create GitHub Issue (via CLI or manual)

**Title:** "ISS-NEW-001: Review data collection not working - diagnosis complete"

**Body:**
```markdown
## Issue
`metrics/review_metrics.json` does not exist, preventing baseline acceptance rate calculation.

## Diagnosis
[Content from `docs/data_collection_diagnosis.md`]

## Blocked By
- PR-003: Need to identify real pilot projects first

## Next Steps
1. Complete PR-003 to identify pilot projects
2. Contact pilot project admins
3. Enable metrics collection in workflows
4. Verify data collection after 7 days
```

---

## Verification Steps

1. **Document Created:**
   ```bash
   test -f docs/data_collection_diagnosis.md && echo "✅ Diagnosis doc created"
   ```

2. **README Updated:**
   ```bash
   grep -q "Data Collection Diagnosis" README.md && echo "✅ README updated"
   ```

3. **Tests Pass:**
   ```bash
   pytest tests/ -q
   ```

---

## Success Criteria

- [ ] `docs/data_collection_diagnosis.md` created with diagnostic commands
- [ ] README.md updated with data collection status notice
- [ ] GitHub issue created to track resolution
- [ ] All tests still passing (documentation-only change)
- [ ] Clear path forward documented for when pilot projects are identified

---

## Risk Assessment

**Risk Level:** VERY LOW

- **Impact:** Documentation only (no code changes)
- **Reversibility:** Trivial (delete files)
- **Dependencies:** None

---

## Rollback Plan

```bash
rm -f docs/data_collection_diagnosis.md
git checkout README.md
gh issue close <issue-number> --comment "Superseded by new approach"
```

---

## Notes

This PR does NOT fix the data collection issue (that requires pilot project access). Instead, it:

1. **Diagnoses** the issue with multiple hypotheses
2. **Documents** resolution steps for pilot project admins
3. **Provides** diagnostic commands to identify root cause
4. **Creates** a tracking issue for follow-up
5. **Updates** README to be transparent about current status

The actual fix will happen after PR-003 is completed (real pilot projects identified).

---

**PR-004 Status:** ✅ READY FOR EXECUTION
**Dependencies:** None (can execute in parallel with PR-003)
**Related to:** ISS-NEW-001, GAP-001
**Priority:** HIGH (Enables baseline calculation once pilot projects are verified)
