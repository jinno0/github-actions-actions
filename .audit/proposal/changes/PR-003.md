# PR-003: Core Functions Verification Script

**Status:** Proposed
**Priority:** High
**Estimated Impact:** High
**Risk:** Medium

## Problem

- 各Actionの動作検証が自動化されていない
- 回帰テストができない
- 本質的機能 (Core Functions) が正常に動作しているか確認できない

## Proposed Solution

### 1. verify_core_functions.py の作成

```python
# .audit/verification/scripts/verify_core_functions.py
#!/usr/bin/env python3
"""
Core Functions Verification Script

リポジトリの存在意義 (Core Functions) が実際に動作するか検証する。
"""

import json
import subprocess
import sys
from pathlib import Path
from typing import Dict, List


class CoreFunctionVerifier:
    def __init__(self):
        self.results: List[Dict] = []

    def verify_action_workflow(self, action_name: str, workflow_path: str) -> bool:
        """ActionのWorkflowファイルが存在し、構文的に正しいことを検証"""
        try:
            # ファイル存在確認
            if not Path(workflow_path).exists():
                return False

            # YAML構文チェック
            result = subprocess.run(
                ["yamllint", "-d", "{extends: default, rules: {line-length: disable}}", workflow_path],
                capture_output=True,
                text=True
            )

            if result.returncode != 0:
                print(f"  ✗ YAML syntax error in {workflow_path}")
                print(f"    {result.stderr}")
                return False

            return True
        except Exception as e:
            print(f"  ✗ Error verifying {action_name}: {e}")
            return False

    def verify_instruction_exists(self, action_name: str) -> bool:
        """各Actionに導入ガイドが存在することを検証"""
        instruction_path = Path(f"instructions/{action_name}.md")
        return instruction_path.exists()

    def verify_examples_exist(self, action_name: str) -> bool:
        """各Actionに実行例が存在することを検証"""
        example_dir = Path(f"examples/{action_name}")
        return example_dir.exists() and len(list(example_dir.iterdir())) > 0

    def run_verification(self) -> Dict:
        """全ての検証を実行"""

        print("=" * 60)
        print("Core Functions Verification")
        print("=" * 60)

        core_functions = [
            {
                "id": "CF-001",
                "name": "review-and-merge",
                "workflow": ".github/workflows/review-and-merge.yml"
            },
            {
                "id": "CF-002",
                "name": "spec-to-code",
                "workflow": ".github/workflows/spec-to-code.yml"
            },
            {
                "id": "CF-003",
                "name": "auto-refactor",
                "workflow": ".github/workflows/auto-refactor.yml"
            },
            # 他のActionも追加可能
        ]

        total = len(core_functions)
        passed = 0

        for func in core_functions:
            print(f"\n[{func['id']}] {func['name']}")

            # 1. Workflow検証
            workflow_ok = self.verify_action_workflow(
                func['name'],
                func['workflow']
            )

            # 2. 導入ガイド検証
            guide_ok = self.verify_instruction_exists(func['name'])
            print(f"  {'✓' if guide_ok else '✗'} Instruction guide")

            # 3. 実行例検証
            example_ok = self.verify_examples_exist(func['name'])
            print(f"  {'✓' if example_ok else '✗'} Examples")

            all_ok = workflow_ok and guide_ok and example_ok

            if all_ok:
                passed += 1
                print(f"  ✓ PASSED")
            else:
                print(f"  ✗ FAILED")

            self.results.append({
                "id": func['id'],
                "name": func['name'],
                "passed": all_ok,
                "workflow_ok": workflow_ok,
                "guide_ok": guide_ok,
                "example_ok": example_ok
            })

        # 結果サマリ
        print("\n" + "=" * 60)
        print(f"Results: {passed}/{total} passed")
        print("=" * 60)

        output = {
            "total": total,
            "passed": passed,
            "failed": total - passed,
            "pass_rate": passed / total if total > 0 else 0,
            "results": self.results
        }

        # 結果をJSONファイルに出力
        output_path = Path(".audit/output/verification_result.json")
        output_path.parent.mkdir(parents=True, exist_ok=True)
        output_path.write_text(json.dumps(output, indent=2, ensure_ascii=False))

        print(f"\nResults saved to: {output_path}")

        return output


if __name__ == "__main__":
    verifier = CoreFunctionVerifier()
    result = verifier.run_verification()

    # 終了コードを返す (失敗があれば1)
    sys.exit(0 if result['failed'] == 0 else 1)
```

### 2. テストデータの作成

```bash
# .audit/verification/test_data/
touch README.md
```

### 3. CI での検証実行

```yaml
# .github/workflows/verify-core-functions.yml
name: Verify Core Functions

on: [push, pull_request]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install yamllint
      - run: python .audit/verification/scripts/verify_core_functions.py
```

## Files to Change

| File | Action | Lines Added | Lines Removed |
|------|--------|-------------|---------------|
| `.audit/verification/scripts/verify_core_functions.py` | Created | ~150 | 0 |
| `.audit/verification/test_data/README.md` | Created | ~5 | 0 |
| `.github/workflows/verify-core-functions.yml` | Created | ~15 | 0 |

## Verification Steps

1. `python .audit/verification/scripts/verify_core_functions.py` を実行
2. 全Actionの検証結果が表示されることを確認
3. `.audit/output/verification_result.json` が出力されることを確認

## Expected Impact

- 全Actionの動作状態を自動検証できる
- 回帰テストが可能になる
- 本質的機能の健全性を継続的に監視できる

## Rollback Plan

```bash
rm .audit/verification/scripts/verify_core_functions.py
rm .audit/verification/test_data/README.md
rm .github/workflows/verify-core-functions.yml
```
