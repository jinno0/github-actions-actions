# PR-003: Integration Test Coverageの完全性回復

**Status:** Ready for Implementation
**Priority:** High
**Estimated Effort:** 2-3 hours
**Gap Addressed:** GAP-002

## 概要

review-and-mergeアクションのintegration testが不足している（12/13）。
これは最も重要なActionの統合テストが不足している状態であり、回帰テストの
網羅性が損なわれている。

## 現状

- **Integration Test Files**: 12/13 (92.3%)
- **Missing Test**: `tests/integration/test_review_and_merge_integration.py`
- **Impact**: 最も使用頻度の高いActionの統合テストが不足

## 提案する変更

### 1. Integration Testの作成

**ファイル**: `tests/integration/test_review_and_merge_integration.py`

```python
"""Integration tests for review-and-merge action."""

import os
import pytest
from pathlib import Path

class TestReviewAndMergeIntegration:
    """Review-and-merge action integration tests."""

    def test_action_directory_structure(self):
        """Test that action directory exists and has required files."""
        action_path = Path("actions/review-and-merge")
        assert action_path.exists(), "Action directory must exist"
        assert (action_path / "action.yml").exists(), "action.yml must exist"
        assert (action_path / "templates").exists(), "templates directory must exist"

    def test_action_yaml_validity(self):
        """Test that action.yml is valid YAML."""
        import yaml
        action_path = Path("actions/review-and-merge/action.yml")
        with open(action_path) as f:
            config = yaml.safe_load(f)
        assert config is not None
        assert "name" in config
        assert "runs" in config

    def test_required_inputs_defined(self):
        """Test that required inputs are defined."""
        import yaml
        action_path = Path("actions/review-and-merge/action.yml")
        with open(action_path) as f:
            config = yaml.safe_load(f)

        inputs = config.get("inputs", {})
        # Claude Code CLI path is critical
        assert "claude-cli-path" in inputs

    def test_template_files_exist(self):
        """Test that all referenced template files exist."""
        action_path = Path("actions/review-and-merge")
        templates_dir = action_path / "templates"

        if templates_dir.exists():
            templates = list(templates_dir.glob("*.md"))
            assert len(templates) > 0, "At least one template must exist"

            for template in templates:
                content = template.read_text()
                assert len(content) > 0, f"Template {template.name} must not be empty"

    def test_instruction_documentation_exists(self):
        """Test that instruction documentation exists."""
        instruction_path = Path("instructions/review-and-merge.md")
        assert instruction_path.exists(), "Instruction documentation must exist"

        content = instruction_path.read_text()
        assert len(content) > 100, "Documentation must have meaningful content"

    def test_example_workflow_exists(self):
        """Test that example workflow exists."""
        example_path = Path("examples/review-and-merge.yml")
        assert example_path.exists(), "Example workflow must exist"

        import yaml
        with open(example_path) as f:
            workflow = yaml.safe_load(f)

        assert "jobs" in workflow, "Workflow must have jobs"
        assert len(workflow["jobs"]) > 0, "Workflow must have at least one job"

    def test_security_patterns(self):
        """Test that action follows security patterns."""
        import yaml
        action_path = Path("actions/review-and-merge/action.yml")
        with open(action_path) as f:
            config = yaml.safe_load(f)

        # Check for path validation if path inputs exist
        inputs = config.get("inputs", {})
        if "path" in inputs:
            # Path validation should be present
            assert inputs["path"].get("required", False) or True

    def test_custom_rules_support(self):
        """Test that custom rules feature is documented."""
        # review-and-merge supports custom rules
        custom_rules_path = Path("instructions/review-and-merge-custom-rules.md")
        assert custom_rules_path.exists(), "Custom rules documentation must exist"
```

### 2. テスト実行による検証

```bash
# 新しいテストを実行
pytest tests/integration/test_review_and_merge_integration.py -v

# 全integration testを実行して網羅性を確認
pytest tests/integration/ -v
```

### 3. CIへの統合

- [ ] 新しいテストがCIでパスすることを確認
- [ ] 全integration testが13/13であることを確認

## 期待される効果

**Before:**
- Integration Test Coverage: 12/13 (92.3%)
- QA-003検証: ❌ FAIL
- 最重要Actionの統合テスト不足

**After:**
- Integration Test Coverage: 13/13 (100%)
- QA-003検証: ✅ PASS
- review-and-mergeの回帰テスト保証

## 成功基準

1. [ ] `test_review_and_merge_integration.py`が作成されている
2. [ ] 全テストがパスする（pytestで0 failures）
3. [ ] Integration Test Coverageが100%になる（13/13 files）
4. [ ] CIでテストが実行され、パスしている

## ロールバック手順

テスト追加のため、ロールバックの必要はない。
万が一テストが他の開発をブロックする場合：

```bash
# テストを一時的にスキップ
mv tests/integration/test_review_and_merge_integration.py \
   tests/integration/test_review_and_merge_integration.py.skip
```

## 副作用とリスク

**副作用**: なし（テスト追加のみ）

**リスク**: 低
- テスト実行時間が若干増加（+1-2秒）
- ただし、品質保証の向上というメリットが上回る

## 依存関係

- なし（単独で実施可能）

## 次のアクション

1. このPR案を承認するか、修正フィードバックを提供
2. test_review_and_merge_integration.pyを作成
3. テストを実行し、全件パスを確認
4. PRを作成し、レビューを依頼
5. マージ後、QA-003の改善を確認

## 参考資料

- Gap Analysis: `.audit/analysis/gap.yml` (GAP-002)
- Verification Result: `.audit/output/verification_result.json` (QA-003)
- Testing Guide: `TESTING.md`
