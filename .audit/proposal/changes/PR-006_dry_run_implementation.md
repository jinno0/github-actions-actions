# PR-006: Dry Run検証の実装追加（残り10 Actions）

**Status**: Proposed  
**Priority**: HIGH  
**Gap ID**: GAP-003  
**Estimated Effort**: 2-3時間  
**Generated by**: audit-run-2026-02-08T13:55:13Z

---

## 概要 (Overview)

README.mdでは「全てのAI ActionsはDry Runモードで自動検証される」と主張しているが、実際には3/13 (23%) のActionsでのみ実装済みである。このドキュメントと実態の乖離を解消するため、未実装の10 ActionsにDry Run検証を追加実装する。

## 現状 (Current State)

**Dry Run実装済み (3/13)**:
- pr-review-enqueuer
- bulk-rebase-prs
- bulk-merge-prs

**未実装 (10/13)**:
- action-fixer
- review-and-merge
- spec-to-code
- auto-document
- release-notes-ai
- auto-rebase
- review-auto-merge
- auto-merge
- auto-refactor
- publish-pr

## 提案する変更 (Proposed Changes)

### 変更1: Dry Run検証の実装パターンを策定

まず、既に実装済みの3 Actionsからベストプラクティスを抽出し、統一パターンを策定する。

**確認対象**:
- `actions/pr-review-enqueuer/` の実装
- `actions/bulk-rebase-prs/` の実装
- `actions/bulk-merge-prs/` の実装

**抽出項目**:
1. Dry Runモードのトリガー方法（入力パラメータ）
2. Claude CLIへの `--dry-run` フラグ渡し方
3. 検証結果の出力形式
4. テストケースの記述方法

### 変更2: 未実装の10 ActionsにDry Run検証を追加

**対象Actions** (優先度順):

1. **review-and-merge** (最高優先度)
   - 理由: コア開発ワークフローの中心
   - 実装内容: `--dry-run` パラメータ追加、レビュー結果のみ出力

2. **action-fixer, spec-to-code** (高優先度)
   - 理由: 頻繁に使用されるコアActions
   - 実装内容: 変更内容のプレビュー機能

3. **auto-document, release-notes-ai** (中優先度)
   - 理由: ドキュメント生成系
   - 実装内容: 生成内容のプレビュー

4. **auto-merge, auto-rebase, review-auto-merge** (中優先度)
   - 理由: PR自動化系
   - 実装内容: マージ/リベースのシミュレーション

5. **auto-refactor, publish-pr** (低優先度)
   - 理由: 使用頻度が相対的に低い
   - 実装内容: 変更内容のプレビュー

### 変更3: テストケースの追加

各Actionに対して、Dry Runモードのテストケースを追加する。

**テストパターン**:
```python
def test_review_and_merge_dry_run():
    """Dry Runモードでは実際の変更を行わない"""
    result = run_action(
        "review-and-merge",
        pr_number=123,
        dry_run=True
    )
    
    # 検証ポイント
    assert result["dry_run"] == True
    assert result["changes_applied"] == False
    assert "preview" in result
```

## 実装手順 (Implementation Steps)

1. **ベストプラクティスの抽出** (30分)
   ```bash
   # 既存実装の調査
   grep -r "dry_run" actions/pr-review-enqueuer/
   grep -r "dry_run" actions/bulk-rebase-prs/
   grep -r "dry_run" actions/bulk-merge-prs/
   ```

2. **実装パターンのドキュメント化** (30分)
   - `docs/dry-run-implementation-guide.md` を作成
   - 統一された実装パターンを記述

3. **各Actionへの実装** (1-2時間)
   - 優先度順に10 Actionsに実装
   - 1 Actionあたり約6-12分

4. **テストの追加** (30分)
   - 各ActionのDry Runテストケースを作成

5. **統合テスト** (15分)
   ```bash
   pytest tests/ -k dry_run -v
   ```

## 期待効果 (Expected Benefits)

1. **安全性向上**: Dry Run検証により、本番環境での意図しない変更を防止
2. **ドキュメントとの整合性**: README.mdの主張と実態が一致
3. **開発者体験の改善**: 利用者が変更内容を事前に確認可能

## 副作用とリスク (Side Effects and Risks)

**リスク**:
- 実装工数が大きい（10 Actions）
- 既存の動作に影響を与える可能性（低いが注意が必要）

**緩和策**:
- まず1 Action (review-and-merge) で実装し、パターンを確立
- 残り9 Actionsには同一パターンを適用
- 既存テストを全てパスさせることを条件に実装

## ロールバック手順 (Rollback Procedure)

問題が発生した場合、以下の手順でロールバックする：

```bash
# 変更を取り消す
git revert <commit-hash>

# または、feature branchを削除
git branch -D feature/dry-run-implementation
```

## 検証方法 (Verification)

**合格基準**:
1. 全てのActions (13/13) がDry Runモードをサポート
2. `pytest tests/ -k dry_run` が全てパス
3. README.mdの記述が実態と一致

**検証コマンド**:
```bash
# テスト実行
pytest tests/ -k dry_run -v

# 検証スクリプト実行
python .audit/verification/verify_core_functions.py  # CF-004がpassedになる
```

## 依存関係 (Dependencies)

- なし（独立して実施可能）

## 参考資料 (References)

- `actions/pr-review-enqueuer/` - 既存のDry Run実装例
- `actions/bulk-rebase-prs/` - 既存のDry Run実装例
- README.md:122-124 - Dry Runに関する記述
- `.audit/analysis/gap.yml` - GAP-003の詳細

## 関連課題 (Related Issues)

- Resolves: GAP-003
- Related: CF-004 (Dry Run検証)

---

**決定**:
- [x] 提案生成完了
- [ ] 実装の実施 (15_executorへ委譲)
- [ ] 検証と完了確認

**次のアクション**:
15_executorがこのPR提案を実際に実装する。実装完了後、CF-004の検証結果を "failed" → "passed" に更新すること。
