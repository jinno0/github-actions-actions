# PR-008: CF-003の機能検証（カスタムレビュールールの動作確認）

**Status**: Proposed  
**Priority**: MEDIUM  
**Gap ID**: ISS-NEW-003  
**Estimated Effort**: 1-2時間  
**Generated by**: audit-run-2026-02-08T13:55:13Z

---

## 概要 (Overview)

CF-003（カスタムレビュールール注入機能）の構造検証は完了したが、実際の動作検証（機能検証）は未実施である。カスタムレビュールールが実際にAIレビューの出力に反映されるかを確認するため、機能検証シナリオを作成し実行する。

## 現状 (Current State)

**構造検証（完了）**:
- ✅ カスタムルール導入ガイドの存在: `instructions/review-and-merge-custom-rules.md`
- ✅ ルールテンプレートの存在: `examples/custom-rules/` (3個)
- ✅ 入力サンプルの存在

**機能検証（未実施）**:
- ❌ カスタムルールが実際にレビュー出力に反映されるかの確認
- ❌ ルール違反が正しく検出されるかの確認
- ❌ 複数ルールの組み合わせテスト

## 提案する変更 (Proposed Changes)

### 変更1: 機能検証シナリオの設計

カスタムレビュールールが実際に動作することを検証するためのシナリオを設計する。

**検証シナリオ1: シングルルールの適用**
- ルール: 「TypeScriptではvarを使用禁止」
- 入力コード: `var x = 10;`
- 期待出力: レビューコメントに「varを使用しないでください」が含まれる

**検証シナリオ2: 複数ルールの適用**
- ルール1: 「関数名はcamelCase」
- ルール2: 「定数はUPPER_SNAKE_CASE」
- 入力コード: 複数の命名規則違反を含むコード
- 期待出力: 両方の違反が検出される

**検証シナリオ3: プロジェクト固有のルール**
- ルール: 「全ての公開関数にはJSDocが必要」
- 入力コード: ドキュメントがない関数
- 期待出力: JSDoc缺失が指摘される

### 変更2: 機能検証スクリプトの作成

`.audit/verification/verify_cf003_functional.py` を作成し、実際にreview-and-merge Actionを動かしてカスタムルールが適用されるかを確認する。

**実装方針**:
```python
def verify_cf003_custom_rules_functional():
    """CF-003: カスタムレビュールールが実際にレビュー出力に反映されるか"""
    
    # 1. テスト用カスタムルールの作成
    custom_rule = {
        "language": "TypeScript",
        "rules": [
            {
                "name": "no-var",
                "pattern": "var\\s+\\w+",
                "message": "varを使用しないでください。constまたはletを使用してください。"
            }
        ]
    }
    
    # 2. テスト用PRの作成（モックまたは実際のPR）
    test_pr_code = """
    function test() {
        var x = 10;
        return x;
    }
    """
    
    # 3. review-and-merge Actionの実行（カスタムルール付き）
    result = run_review_and_merge(
        pr_number=999,
        custom_rules=custom_rule,
        dry_run=True  # 実際にはマージしない
    )
    
    # 4. レビュー結果にカスタムルール違反が含まれているか検証
    assert "varを使用しないでください" in result["review_comments"]
    assert result["rules_applied"] == True
    
    return VerificationResult(
        function_id="CF-003",
        scenario_name="カスタムレビュールールの機能検証",
        passed=True,
        actual_output=result["review_comments"],
        expected_output=["varを使用しないでください"],
        interpretation="カスタムルールが実際にレビュー出力に反映された"
    )
```

### 変更3: テストデータの作成

`.audit/test_data/custom_rules/` ディレクトリに検証用のカスタムルールファイルを作成する。

**ファイル構造**:
```
.audit/test_data/custom_rules/
├── typescript-no-var.json
├── typesscript-naming.json
└── javascript-jsdoc.json
```

### 変更4: verify_core_functions.pyの更新

CF-003の検証ステータスを "not_verified" → "passed" (機能検証完了) に更新する。

```python
# intent.yml
core_functions:
  - id: "CF-003"
    claim: "カスタムレビュールール注入機能を提供し、プロジェクト固有のコーディング規約をAIレビューに反映できる"
    verified_status: "passed"
    verification_result: "構造検証 + 機能検証完了"
    note: "verify_cf003_functional.pyで実際の動作を確認"
```

## 実装手順 (Implementation Steps)

1. **検証シナリオの詳細設計** (20分)
   - 3つのシナリオの具体的な入力・出力を定義
   - 期待される動作を明確化

2. **テストデータの作成** (15分)
   ```bash
   mkdir -p .audit/test_data/custom_rules
   
   # カスタムルールファイルの作成
   cat > .audit/test_data/custom_rules/typescript-no-var.json << 'RULE'
   {
     "language": "TypeScript",
     "rules": [
       {
         "name": "no-var",
         "description": "varの使用を禁止",
         "severity": "error",
         "pattern": "var\\s+\\w+",
         "message": "varを使用しないでください。constまたはletを使用してください。"
       }
     ]
   }
   RULE
   ```

3. **機能検証スクリプトの作成** (30-45分)
   - `.audit/verification/verify_cf003_functional.py` の実装
   - review-and-merge Actionを呼び出し、実際にレビューを実行
   - カスタムルールが適用されたかを検証

4. **検証スクリプトの実行** (10分)
   ```bash
   python .audit/verification/verify_cf003_functional.py
   ```

5. **結果の記録** (5分)
   - 検証結果を `.audit/output/verification_result.json` に追加
   - CF-003のステータスを更新

## 期待効果 (Expected Benefits)

1. **機能の保証**: カスタムレビュールールが実際に動作することを証明
2. **ユーザー信頼性の向上**: 機能検証済みであることを明示できる
3. **ドキュメントとの整合性**: README.mdの主張を裏付ける

## 副作用とリスク (Side Effects and Risks)

**リスク**:
- 検証実行時に実際にレビューコメントが投稿される可能性（Dry Runモードで回避）

**緩和策**:
- 必ず `dry_run=True` で実行する
- テスト用PRには明確なマーカーを付け、本番PRと区別する

## ロールバック手順 (Rollback Procedure)

```bash
# テストデータの削除
rm -rf .audit/test_data/custom_rules/

# 検証スクリプトの削除
rm .audit/verification/verify_cf003_functional.py
```

## 検証方法 (Verification)

**合格基準**:
1. 3つの検証シナリオ全てでパス
2. カスタムルールがレビュー出力に反映されている
3. verify_cf003_functional.py がエラーなしで実行完了

**検証コマンド**:
```bash
# 機能検証スクリプト実行
python .audit/verification/verify_cf003_functional.py

# 期待する出力
# ✅ PASS [CF-003] カスタムレビュールールの機能検証
#   解釈: カスタムルールが実際にレビュー出力に反映された
```

## 依存関係 (Dependencies)

- review-and-merge Actionが動作していること
- Claude Code CLIがインストールされていること
- GitHubトークンが設定されていること

## 参考資料 (References)

- `instructions/review-and-merge-custom-rules.md` - カスタムルール導入ガイド
- `examples/custom-rules/` - ルールテンプレート
- `.audit/verification/verify_cf003_cf006.py` - 構造検証スクリプト
- README.md:65-77 - カスタムレビュールールに関する記述

## 関連課題 (Related Issues)

- Resolves: ISS-NEW-003
- Related: CF-003 (カスタムレビュールール注入)
- Updates: CF-003のverified_statusを "passed" (機能検証完了)

---

**決定**:
- [x] 提案生成完了
- [ ] 機能検証スクリプトの実装と実行 (15_executorへ委譲)
- [ ] 検証と完了確認

**次のアクション**:
15_executorがこのPR提案を実施する。機能検証完了後、ISS-NEW-003を "resolved" に更新し、CF-003のverified_statusを "passed (機能検証完了)" に更新すること。
