# PR-006: Dry Run検証の実装（残り10 Actions）

## 概要 (Overview)

**Gap**: GAP-003 (Dry Run検証の実装不足)
**Severity**: High
**Priority**: 1
**Estimated Effort**: 2-3 hours

現在3/13 Actions (23%) にのみ実装されているDry Run検証を、残り10 Actionsにも実装し、README.md:122-124 の主張「全てのAI ActionsはDry Runモードで自動検証される」を实现します。

## 現状 (Current State)

### 実装済み (3 Actions)
- `bulk-merge-prs` - DRY_RUN環境変数で実装済み
- `bulk-rebase-prs` - DRY_RUN環境変数で実装済み
- `pr-review-enqueuer` - DRY_RUN環境変数で実装済み

### 未実装 (10 Actions)
1. `action-fixer`
2. `auto-document`
3. `auto-merge`
4. `auto-refactor`
5. `auto-rebase`
6. `publish-pr`
7. `release-notes-ai`
8. `review-and-merge`
9. `review-auto-merge`
10. `spec-to-code`

## 提案する変更 (Proposed Changes)

### パターン: Dry Run実装テンプレート

既存の実装済み3 Actionsのパターンを分析し、以下の標準実装を提案します:

```yaml
# action.yml に追加
inputs:
  DRY_RUN:
    description: "Dry run mode (skip actual changes)"
    required: false
    default: "false"
    
env:
  DRY_RUN: ${{ inputs.DRY_RUN }}
```

```python
# Python実装パターン
import os
import sys

def main():
    dry_run = os.getenv('DRY_RUN', 'false').lower() in ('true', '1', 'yes')
    
    if dry_run:
        print("::warning::DRY RUN MODE - No changes will be made")
        # Dry Run時の処理（出力のみ、実際の変更はスキップ）
        return
    
    # 通常処理
    # ...
```

### 実装ステップ

各Actionに対して以下を実施:

1. **action.ymlの修正**
   - `inputs.DRY_RUN` の追加
   - `env.DRY_RUN` の設定

2. **メインスクリプトの修正**
   - 環境変数 `DRY_RUN` の読み込み
   - Dry Run分岐の追加
   - 適切なログ出力（`::warning::` 使用）

3. **テストの追加**
   - `tests/test_{action_name}/test_{action_name}_action.py` に `test_dry_run_mode` を追加
   - Dry Run時の動作を検証

### 具体例: review-and-merge

#### 変更前 (actions/review-and-merge/action.yml)
```yaml
inputs:
  github_token:
    description: "GitHub token"
    required: true
```

#### 変更後 (actions/review-and-merge/action.yml)
```yaml
inputs:
  github_token:
    description: "GitHub token"
    required: true
  DRY_RUN:
    description: "Dry run mode (skip actual changes)"
    required: false
    default: "false"
```

#### 変更前 (actions/review-and-merge/review.py)
```python
def main():
    # Process PR
    subprocess.run(["claude", "code", ...])
```

#### 変更後 (actions/review-and-merge/review.py)
```python
def main():
    dry_run = os.getenv('DRY_RUN', 'false').lower() in ('true', '1', 'yes')
    
    if dry_run:
        print("::warning::DRY RUN MODE: Skipping actual review")
        print(f"Would review PR: {pr_number}")
        return
    
    # 通常処理
    subprocess.run(["claude", "code", ...])
```

#### テスト追加 (tests/test_review_and_merge/test_review_action.py)
```python
def test_dry_run_mode(self):
    """Test that DRY_RUN mode skips actual changes"""
    with tempfile.TemporaryDirectory() as tmpdir:
        result = subprocess.run(
            [sys.executable, self.action_script, "--dry-run", "--repo", tmpdir],
            capture_output=True,
            text=True
        )
        
        self.assertIn("DRY RUN MODE", result.stdout)
        self.assertEqual(result.returncode, 0)
```

## 検証基準 (Success Criteria)

1. **構造チェック**: 13/13 Actionsが `DRY_RUN` inputを持つ
   ```bash
   grep -r "DRY_RUN" actions/*/action.yml | wc -l  # Expected: 13
   ```

2. **テストパス**: すべてのDry Runテストがパス
   ```bash
   pytest tests/ -k dry_run -v
   # Expected: 13 passed
   ```

3. **CF-004達成**: Core Function VerificationでCF-004がpassedになる
   ```bash
   python .audit/verification/scripts/verify_core_functions.py
   # Expected: CF-004 status: passed
   ```

## リスク評価 (Risk Assessment)

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| 既存ワークフローへの影響 | Medium | `default: "false"` で既定動作を変更せず |
| テスト実装漏れ | Low | 各Actionに必ずテストを追加 |
| Claude CLI呼び出しの分岐漏れ | Medium | 既存コードのレビューを実施 |

## ロールバック手順 (Rollback)

各Actionの変更は独立しているため、問題が発生した場合:

1. 該当Actionのコミットをrevert
2. 他の9 Actionsの実装を継続可能

## 実装順序の推奨 (Recommended Order)

優先度順（Claude CLI統合の有無、複雑度を考慮）:

1. **Simple (5 Actions)**: `publish-pr`, `auto-merge`, `review-auto-merge`, `auto-document`, `release-notes-ai`
2. **Medium (3 Actions)**: `action-fixer`, `auto-refactor`, `auto-rebase`
3. **Complex (2 Actions)**: `review-and-merge`, `spec-to-code`

## 参考資料 (References)

- 既存実装: `actions/bulk-merge-prs/action.yml`
- 既存テスト: `tests/test_bulk_merge_prs/test_bulk_merge_prs_action.py`
- ドキュメント: `README.md:122-124`

## 関連ファイル (Related Files)

変更予定のファイル:
- `actions/{action-name}/action.yml` (10 files)
- `actions/{action-name}/*.py` (implementation files)
- `tests/test_{action_name}/test_{action_name}_action.py` (test files)
- `.audit/analysis/gap.yml` (GAP-003をresolvedに更新)
- `.audit/config/intent.yml` (CF-004のverified_statusをpassedに更新)

## メタデータ

- **Proposed by**: audit-run-2026-02-08T17:24:21Z
- **Based on**: feedback_to_auditor.yml (priority 1 recommendation)
- **Previous attempts**: None (first implementation cycle)
- **Dependencies**: None
- **Blocks**: GAP-003の解決、CF-004の達成
