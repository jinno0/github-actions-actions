name: 'Auto Rebase PR with AI Conflict Resolution'
description: 'Automatically rebase a PR and resolve conflicts using Claude Code CLI'
inputs:
  github-token:
    description: 'GitHub token with repo permissions'
    required: true
  pr-number:
    description: 'PR number to rebase (optional, defaults to event context)'
    required: false
  claude-model:
    description: 'Claude model to use (default: sonnet)'
    required: false
    default: 'sonnet'
  rebase-strategy:
    description: 'Rebase strategy: interactive (ai-assisted) or force (always use ai)'
    required: false
    default: 'interactive'
  conflict-resolution-prompt-template:
    description: 'Path to custom conflict resolution prompt template (optional)'
    required: false
    default: ''
outputs:
  rebased:
    description: 'Whether the PR was successfully rebased (true/false)'
    value: ${{ steps.rebase.outputs.rebased }}
  conflicts-resolved:
    description: 'Whether conflicts were resolved by AI (true/false)'
    value: ${{ steps.rebase.outputs.conflicts_resolved }}
  conflict-count:
    description: 'Number of conflicts encountered'
    value: ${{ steps.rebase.outputs.conflict_count }}
runs:
  using: 'composite'
  steps:
    - name: Install Claude CLI
      shell: bash
      run: |
        if ! command -v claude &> /dev/null; then
          echo "Installing Claude Code CLI..."
          npm install -g @github/copilot
          echo "âœ“ Claude CLI installed"
        else
          echo "âœ“ Claude CLI already installed"
        fi

    - name: Checkout PR
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        # Determine PR number from event or inputs
        if [ -n "${{ inputs.pr-number }}" ]; then
          PR_NUMBER=${{ inputs.pr-number }}
        else
          PR_NUMBER=${{ github.event.pull_request.number }}
        fi

        if [ -z "$PR_NUMBER" ]; then
          echo "::error::No PR number found. This action requires either pull_request trigger or pr-number input."
          exit 1
        fi

        echo "Checking out PR #$PR_NUMBER..."
        gh pr checkout $PR_NUMBER

        # Get base branch name and save to file for later steps
        gh pr view "$PR_NUMBER" --json baseRefName -q '.baseRefName' > /tmp/base_branch.txt

    - name: Fetch latest base branch
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        BASE_BRANCH=$(cat /tmp/base_branch.txt)
        echo "Fetching latest $BASE_BRANCH..."
        git fetch origin "$BASE_BRANCH:origin/$BASE_BRANCH"

    - name: Rebase with AI conflict resolution
      shell: bash
      id: rebase
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        # Don't exit on error - we need to handle rebase conflicts
        set +e

        # Determine PR number from event or inputs
        if [ -n "${{ inputs.pr-number }}" ]; then
          PR_NUMBER=${{ inputs.pr-number }}
        else
          PR_NUMBER=${{ github.event.pull_request.number }}
        fi

        MODEL="${{ inputs.claude-model }}"
        STRATEGY="${{ inputs.rebase-strategy }}"
        CUSTOM_TEMPLATE="${{ inputs.conflict-resolution-prompt-template }}"

        BASE_BRANCH=$(cat /tmp/base_branch.txt)
        CURRENT_BRANCH=$(git branch --show-current)

        echo "### Attempting to rebase PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
        echo "- Base branch: $BASE_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- Current branch: $CURRENT_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- Strategy: $STRATEGY" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Attempt rebase (capture output to avoid triggering exit on error)
        REBASE_OUTPUT=$(git rebase "origin/$BASE_BRANCH" 2>&1) || REBASE_EXIT_CODE=$?
        if [ -z "$REBASE_EXIT_CODE" ]; then
          # Rebase succeeded (no exit code set)
          echo "âœ… Rebase successful - no conflicts" >> $GITHUB_STEP_SUMMARY
          git push --force-with-lease
          echo "rebased=true" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Conflicts detected
        echo "âš ï¸ Conflicts detected during rebase" >> $GITHUB_STEP_SUMMARY

        # Count conflicts
        CONFLICT_COUNT=$(git diff --name-only --diff-filter=U | wc -l)
        echo "Found $CONFLICT_COUNT file(s) with conflicts" >> $GITHUB_STEP_SUMMARY

        # List conflicted files
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Conflicted files:**" >> $GITHUB_STEP_SUMMARY
        git diff --name-only --diff-filter=U | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY

        # Prepare prompt for Claude
        if [ -n "$CUSTOM_TEMPLATE" ] && [ -f "$CUSTOM_TEMPLATE" ]; then
          PROMPT_FILE="$CUSTOM_TEMPLATE"
        else
          PROMPT_FILE="${{ github.action_path }}/templates/conflict_resolution_prompt.txt"
        fi

        # Create prompt with conflict details
        # Use | as delimiter to avoid issues with / in branch names
        sed -e "s|{BASE_BRANCH}|$BASE_BRANCH|g" \
            -e "s|{CURRENT_BRANCH}|$CURRENT_BRANCH|g" \
            -e "s|{PR_NUMBER}|$PR_NUMBER|g" \
            "$PROMPT_FILE" > /tmp/conflict_prompt.txt

        # Add conflict markers info to prompt
        echo "" >> /tmp/conflict_prompt.txt
        echo "## Conflicted Files:" >> /tmp/conflict_prompt.txt
        git diff --name-only --diff-filter=U | while read file; do
          echo "" >> /tmp/conflict_prompt.txt
          echo "### $file" >> /tmp/conflict_prompt.txt
          echo '```' >> /tmp/conflict_prompt.txt
          cat "$file" >> /tmp/conflict_prompt.txt
          echo '```' >> /tmp/conflict_prompt.txt
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¤– Asking Claude Code CLI to resolve conflicts..." >> $GITHUB_STEP_SUMMARY

        # Run Claude to resolve conflicts (may fail, but we check results)
        # Use -p for print mode (non-interactive)
        claude -p --dangerously-skip-permissions --model "$MODEL" < /tmp/conflict_prompt.txt > /tmp/claude_output.txt 2>&1 || true

        # Show Claude output in summary
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Claude output:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat /tmp/claude_output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        # Check if conflicts were resolved (files were modified)
        if git diff --quiet; then
          echo "âŒ No changes made by Claude - conflicts remain" >> $GITHUB_STEP_SUMMARY
          # Abort rebase and restore original state
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Stage the resolved files
        echo "Staging resolved files..." >> $GITHUB_STEP_SUMMARY
        git add --update

        # Check if all conflicts are resolved
        REMAINING=$(git diff --name-only --diff-filter=U | wc -l)
        if [ "$REMAINING" -gt 0 ]; then
          echo "âš ï¸ $REMAINING file(s) still have conflicts after Claude intervention" >> $GITHUB_STEP_SUMMARY
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Continue rebase after conflict resolution
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Continuing rebase..." >> $GITHUB_STEP_SUMMARY

        CONTINUE_OUTPUT=$(git rebase --continue 2>&1) || CONTINUE_EXIT_CODE=$?
        if [ -z "$CONTINUE_EXIT_CODE" ]; then
          # Push rebased branch
          echo "Pushing rebased branch..." >> $GITHUB_STEP_SUMMARY
          git push --force-with-lease

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Rebase completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "rebased=true" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=true" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âŒ Failed to complete rebase after conflict resolution" >> $GITHUB_STEP_SUMMARY
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi
