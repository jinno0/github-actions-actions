name: 'Auto Rebase PR with Automatic Conflict Resolution'
description: 'Automatically rebase a PR and resolve conflicts by preferring PR branch changes'
inputs:
  github-token:
    description: 'GitHub token with repo permissions'
    required: true
  pr_number:
    description: 'PR number to rebase (optional, defaults to event context)'
    required: false
  claude-model:
    description: 'Claude model to use (default: claude-sonnet-4.5)'
    required: false
    default: 'claude-sonnet-4.5'
  rebase-strategy:
    description: 'Rebase strategy: interactive (ai-assisted) or force (always use ai)'
    required: false
    default: 'interactive'
  conflict-resolution-prompt-template:
    description: 'Path to custom conflict resolution prompt template (optional)'
    required: false
    default: ''
outputs:
  rebased:
    description: 'Whether the PR was successfully rebased (true/false)'
    value: ${{ steps.rebase.outputs.rebased }}
  conflicts-resolved:
    description: 'Whether conflicts were resolved by AI (true/false)'
    value: ${{ steps.rebase.outputs.conflicts_resolved }}
  conflict-count:
    description: 'Number of conflicts encountered'
    value: ${{ steps.rebase.outputs.conflict_count }}
runs:
  using: 'composite'
  steps:
    - name: Check for Claude CLI
      shell: bash
      run: |
        # Check if claude is already installed (self-hosted runners only)
        if command -v claude &> /dev/null; then
          echo "âœ“ Claude CLI available (self-hosted runner)"
          claude --version || true
          echo "CLAUDE_AVAILABLE=true" >> $GITHUB_ENV
          echo "CLAUDE_CMD=claude" >> $GITHUB_ENV
        else
          echo "âš ï¸ Claude CLI not found. Conflict resolution requires self-hosted runner with claude command."
          echo "CLAUDE_AVAILABLE=false" >> $GITHUB_ENV
          echo "CLAUDE_CMD=" >> $GITHUB_ENV
        fi

    - name: Checkout PR
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        # Determine PR number from event or inputs
        if [ -n "${{ inputs.pr_number }}" ]; then
          PR_NUMBER=${{ inputs.pr_number }}
        else
          PR_NUMBER=${{ github.event.pull_request.number }}
        fi

        if [ -z "$PR_NUMBER" ]; then
          echo "::error::No PR number found. This action requires either pull_request trigger or pr-number input."
          exit 1
        fi

        echo "Checking out PR #$PR_NUMBER..."
        gh pr checkout $PR_NUMBER

        # Get base branch name and save to file for later steps
        gh pr view "$PR_NUMBER" --json baseRefName -q '.baseRefName' > /tmp/base_branch.txt

    - name: Fetch latest base branch
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        BASE_BRANCH=$(cat /tmp/base_branch.txt)
        echo "Fetching latest $BASE_BRANCH..."
        git fetch origin "$BASE_BRANCH:origin/$BASE_BRANCH"

    - name: Rebase with AI conflict resolution
      shell: bash
      id: rebase
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        # Don't exit on error - we need to handle rebase conflicts
        set +e

        # Determine PR number from event or inputs
        if [ -n "${{ inputs.pr_number }}" ]; then
          PR_NUMBER=${{ inputs.pr_number }}
        else
          PR_NUMBER=${{ github.event.pull_request.number }}
        fi

        MODEL="${{ inputs.claude-model }}"
        STRATEGY="${{ inputs.rebase-strategy }}"
        CUSTOM_TEMPLATE="${{ inputs.conflict-resolution-prompt-template }}"

        BASE_BRANCH=$(cat /tmp/base_branch.txt)
        CURRENT_BRANCH=$(git branch --show-current)

        echo "### Attempting to rebase PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
        echo "- Base branch: $BASE_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- Current branch: $CURRENT_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "- Strategy: $STRATEGY" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Attempt rebase (capture output to avoid triggering exit on error)
        REBASE_OUTPUT=$(git rebase "origin/$BASE_BRANCH" 2>&1) || REBASE_EXIT_CODE=$?
        if [ -z "$REBASE_EXIT_CODE" ]; then
          # Rebase succeeded (no exit code set)
          echo "âœ… Rebase successful - no conflicts" >> $GITHUB_STEP_SUMMARY
          git push --force-with-lease
          echo "rebased=true" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check if there are actual conflicts
        CONFLICT_COUNT=$(git diff --name-only --diff-filter=U | wc -l)

        if [ "$CONFLICT_COUNT" -eq 0 ]; then
          # No conflicts detected, but rebase failed for another reason
          echo "âš ï¸ Rebase failed but no conflicts detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rebase output:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$REBASE_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=0" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âš ï¸ Conflicts detected during rebase" >> $GITHUB_STEP_SUMMARY
        echo "Found $CONFLICT_COUNT file(s) with conflicts" >> $GITHUB_STEP_SUMMARY

        # List conflicted files
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Conflicted files:**" >> $GITHUB_STEP_SUMMARY
        git diff --name-only --diff-filter=U | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY

        # Prepare prompt for Claude
        if [ -n "$CUSTOM_TEMPLATE" ] && [ -f "$CUSTOM_TEMPLATE" ]; then
          PROMPT_FILE="$CUSTOM_TEMPLATE"
        else
          PROMPT_FILE="${{ github.action_path }}/templates/conflict_resolution_prompt.txt"
        fi

        # Create prompt with conflict details
        # Use | as delimiter to avoid issues with / in branch names
        sed -e "s|{BASE_BRANCH}|$BASE_BRANCH|g" \
            -e "s|{CURRENT_BRANCH}|$CURRENT_BRANCH|g" \
            -e "s|{PR_NUMBER}|$PR_NUMBER|g" \
            "$PROMPT_FILE" > /tmp/conflict_prompt.txt

        # Add conflicted file list to prompt (just names, Claude will read them)
        echo "" >> /tmp/conflict_prompt.txt
        echo "## Conflicted Files:" >> /tmp/conflict_prompt.txt
        git diff --name-only --diff-filter=U | while read file; do
          echo "- \`$file\`" >> /tmp/conflict_prompt.txt
        done
        echo "" >> /tmp/conflict_prompt.txt
        echo "Please use the Read tool to examine each file above, then use the Edit tool to resolve conflicts." >> /tmp/conflict_prompt.txt

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¤– Asking Claude Code CLI to resolve conflicts..." >> $GITHUB_STEP_SUMMARY

        # Check if Claude CLI is available
        if [ "$CLAUDE_AVAILABLE" != "true" ]; then
          echo "âŒ Claude CLI not available. Cannot resolve conflicts automatically." >> $GITHUB_STEP_SUMMARY
          echo "This action requires a self-hosted runner with 'claude' command installed." >> $GITHUB_STEP_SUMMARY
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Run Claude in interactive mode (without -p) so it can use tools
        # Give it a simple prompt to resolve the rebase conflicts
        echo "We are in the middle of a git rebase and there are merge conflicts." > /tmp/claude_prompt.txt
        echo "" >> /tmp/claude_prompt.txt
        echo "Base branch: $BASE_BRANCH" >> /tmp/claude_prompt.txt
        echo "Current branch: $CURRENT_BRANCH" >> /tmp/claude_prompt.txt
        echo "PR Number: $PR_NUMBER" >> /tmp/claude_prompt.txt
        echo "" >> /tmp/claude_prompt.txt
        echo "Please:" >> /tmp/claude_prompt.txt
        echo "1. Use the Read tool to examine each conflicted file" >> /tmp/claude_prompt.txt
        echo "2. Use the Edit tool to resolve conflicts by removing conflict markers" >> /tmp/claude_prompt.txt
        echo "3. Prefer keeping changes from the current branch (the PR being rebased)" >> /tmp/claude_prompt.txt
        echo "4. Remove all <<<<<<<, =======, and >>>>>>> markers" >> /tmp/claude_prompt.txt
        echo "5. Save each file after resolving" >> /tmp/claude_prompt.txt
        echo "" >> /tmp/claude_prompt.txt
        echo "DO NOT commit. Just resolve the conflicts and save the files." >> /tmp/claude_prompt.txt

        $CLAUDE_CMD --dangerously-skip-permissions --model "$MODEL" < /tmp/claude_prompt.txt

        # Show Claude output in summary
        echo "" >> $GITHUB_STEP_SUMMARY

        # Stage all resolved files (required for git rebase --continue)
        echo "Staging resolved files..." >> $GITHUB_STEP_SUMMARY
        git add -A

        # Check if all conflicts are resolved
        REMAINING=$(git diff --name-only --diff-filter=U | wc -l)
        if [ "$REMAINING" -gt 0 ]; then
          echo "âŒ Failed to resolve conflicts - $REMAINING file(s) still conflicted" >> $GITHUB_STEP_SUMMARY
          # Abort rebase and restore original state
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Continue rebase after conflict resolution
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Continuing rebase..." >> $GITHUB_STEP_SUMMARY

        # Set GIT_EDITOR to prevent interactive prompts
        export GIT_EDITOR=true
        export GIT_SEQUENCE_EDITOR=true

        CONTINUE_OUTPUT=$(git rebase --continue 2>&1) || CONTINUE_EXIT_CODE=$?
        if [ -z "$CONTINUE_EXIT_CODE" ]; then
          # Push rebased branch
          echo "Pushing rebased branch..." >> $GITHUB_STEP_SUMMARY
          git push --force-with-lease

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Rebase completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "rebased=true" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=true" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
        else
          echo "âŒ Failed to complete rebase after conflict resolution" >> $GITHUB_STEP_SUMMARY
          git rebase --abort 2>/dev/null || true
          echo "rebased=false" >> $GITHUB_OUTPUT
          echo "conflicts_resolved=false" >> $GITHUB_OUTPUT
          echo "conflict_count=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          exit 1
        fi
