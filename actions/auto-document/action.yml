name: 'Auto Document'
description: 'Automatically update documentation based on code changes using Claude Code CLI'
inputs:
  source-path:
    description: 'Path to source code to analyze'
    required: false
    default: '.'
  doc-path:
    description: 'Path to the document to update (e.g., README.md)'
    required: false
    default: 'README.md'
  claude-model:
    description: 'Claude model to use (default: sonnet)'
    required: false
    default: 'sonnet'
  doc-prompt-template:
    description: 'Path to custom doc prompt template (optional, uses built-in template if not specified)'
    required: false
runs:
  using: 'composite'
  steps:
    - name: Update Documentation with Claude Code CLI
      shell: bash
      run: |
        # Source shared validation functions
        source "${{ github.action_path }}/../_shared/scripts/validate-template-path.sh"

        SOURCE_PATH="${{ inputs.source-path }}"
        DOC_PATH="${{ inputs.doc-path }}"
        MODEL="${{ inputs.claude-model }}"

        echo "Updating $DOC_PATH based on source in $SOURCE_PATH..."

        DOC_PROMPT_TEMPLATE="${{ inputs.doc-prompt-template }}"

        # Validate and resolve template path using shared function
        BUILTIN_TEMPLATE="${{ github.action_path }}/templates/doc_prompt.txt"
        if ! validate_template_path "$DOC_PROMPT_TEMPLATE" "$BUILTIN_TEMPLATE" TEMPLATE_FILE; then
          exit 1
        fi

        # Read template and replace placeholders safely using awk
        DOC_PROMPT=$(awk -v source_path="$SOURCE_PATH" \
                         -v doc_path="$DOC_PATH" \
                         '{
                           gsub(/\{SOURCE_PATH\}/, source_path)
                           gsub(/\{DOC_PATH\}/, doc_path)
                           print
                         }' "$TEMPLATE_FILE")

        # Check Claude CLI availability using shared function
        if ! check_claude_cli; then
          exit 1
        fi

        # Run Claude Code CLI in safe mode (no --dangerously-skip-permissions)
        claude --model "$MODEL" <<< "$DOC_PROMPT"

